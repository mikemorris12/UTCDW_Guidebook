

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6.1 Edmonton AC Loads: Single Simulation Analysis &#8212; UTCDW Guidebook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Chapter6/section6.1_station_1D_example_onesim';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.2 Edmonton AC Loads: Multi-Model Analysis" href="section6.2_station_1D_example_multimodel.html" />
    <link rel="prev" title="Chapter 6: Workflow Examples" href="chapter6.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    UTCDW Guidebook
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter1/chapter1.html">Chapter 1: Introduction</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/section1.1_python_env.html">1.1 Setting Up Your Python Environment</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter2/chapter2.html">Chapter 2: Intro to Climate Science and Modeling</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.1_climate_basics.html">2.1 Climate Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.2_climate_modeling.html">2.2 Climate Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.3_climate_model_uncertainty.html">2.3 Climate Model Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/chapter2_summary.html">2.4 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter3/chapter3.html">Chapter 3: Exploring Climate Data</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.1_station_data.html">3.1 Station Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.2_gridded_obs.html">3.2 Gridded Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.3_reanalysis.html">3.3 Reanalysis Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.4_climate_model_output.html">3.4 Climate Model Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.5_model_data_on_google_cloud.html">3.5 Climate Model Data on Google Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/chapter3_summary.html">3.6 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter4/chapter4.html">Chapter 4: Statistical Downscaling</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.1_downscaling_basics.html">4.1 Downscaling Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.2_bias_correction_methods.html">4.2 Bias-Correction Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.3_downscaling_methods.html">4.3 Downscaling Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.4_downscaling_validation.html">4.4 Downscaling Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.5_assessing_downscaled_projections.html">4.5 Assessing Downscaled Climate Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/chapter4_summary.html">4.6 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter5/chapter5.html">Chapter 5: Downscaling Workflow</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.1_climate_indicators.html">5.1 Climate Indicators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.2_data_selection.html">5.2 Data Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.3_exploratory_data_analysis.html">5.3 Exploratory Data Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.4_producing_downscaled_data.html">5.4 Producing Downscaled Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/chapter5_summary.html">5.5 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="chapter6.html">Chapter 6: Workflow Examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">6.1 Edmonton AC Loads: Single Simulation Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.2_station_1D_example_multimodel.html">6.2 Edmonton AC Loads: Multi-Model Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.3_station_1D_example_multiscen.html">6.3 Edmonton AC Loads: Multi-Scenario Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.4_station_1D_example_nearterm.html">6.4 Edmonton AC Loads: Near-Term Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.5_gridded_DBCCA_example.html">6.5 Edmonton AC Loads: Gridded Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../guidebook_references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Chapter6/section6.1_station_1D_example_onesim.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>6.1 Edmonton AC Loads: Single Simulation Analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminary-study-design">6.1.1 Preliminary Study Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-and-downloading-the-datasets">6.1.2 Selecting and Downloading the Datasets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-model-obs-consistency">6.1.3 Assessing Model-Obs Consistency</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-climate-change-signal">6.1.4 Evaluating the Climate Change Signal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-the-bias-correction">6.1.5 Applying the Bias Correction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validating-the-bias-corrected-data">6.1.6 Validating the Bias-Corrected Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downscaled-projections-of-our-climate-indicator">6.1.7 Downscaled Projections of our Climate Indicator</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="edmonton-ac-loads-single-simulation-analysis">
<h1>6.1 Edmonton AC Loads: Single Simulation Analysis<a class="headerlink" href="#edmonton-ac-loads-single-simulation-analysis" title="Permalink to this heading">#</a></h1>
<p>This toy example is about the potential effects of climate change on air conditioning loads in the Canadian city of Edmonton. To start small, this example will focus on a single spatial location, and as such, will demonstrate only <em>bias-correction</em> of climate model data, not true spatial downscaling.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because of the small scope of this example, you should be able to run the code on a personal computer (like all of the previous notebooks). The later examples which involve spatial downscaling will likely require more memory and processing power than a laptop or basic desktop computer can handle.</p>
</div>
<div class="section" id="preliminary-study-design">
<h2>6.1.1 Preliminary Study Design<a class="headerlink" href="#preliminary-study-design" title="Permalink to this heading">#</a></h2>
<p>Before starting any analysis, some preliminary decisions must be made. The <a class="reference external" href="https://utcdw.physics.utoronto.ca/survey/">guided survey provided by the UTCDW</a> will help you work through each of the necessary decisions, explained in more detail in Chapter 5 of the UTCDW Guidebook. Herein we’ll specify the responses to each survey question, and generate a flowchart that will guide us through the steps of the analysis.</p>
<p>The first few questions of the survey have already been answered, just by defining our study problem. The subject of our study is changes to AC loads in Edmonton, which itself already includes the <strong>spatial domain</strong> we will study.</p>
<p>Next, we need to decide on the time periods of analysis, one to establish the historical baseline from which changes will be measured, and the other to use for future projections. Each period should be at least 30 years long, which is the standard for establishing climate normals. For the historical baseline, we will choose <strong>1980-2010</strong>. This period is entirely covered by the historical CMIP6 simulations, which end in the year 2015. It also will allow us to later use the NRCanMet gridded observational data from PCIC, which is only available up to the year 2010. For the future period, we’ll use the end-of-century period <strong>2070-2100</strong>. For a practical study, you might be interested in a closer-term future period, but using an end-of-century period for this pedagogical will maximize the strength of the signal.</p>
<p>For our future period, we must also specify one or more future scenarios to study, since we cannot know exactly what future emissions of climate forcers like greenhouse gases will be. To continue with the theme of starting small, we’ll begin with data from only one model and one future scenario to develop our code. After going through the whole bias-correction workflow with this model, we’ll expand the analysis to include multiple models and scenarios.</p>
<p>The scenario we will start with is SSP3-7.0. This is a high emissions scenario (but not the highest) and represents a future of “Regional Rivalry” where countries focus on their own economic goals instead of international cooperation on environmental issues.</p>
<p>The model we’ll begin with is the <a class="reference external" href="https://www.cesm.ucar.edu/models/cesm2">NCAR Community Earth System Model version 2</a>. CESM2 is a state-of-the-art Earth System Model contributing to CMIP6 and is developed by a large team of scientists in the USA. The results from this model aren’t particularly special in the context of the CMIP6 ensemble, though it does have an <a class="reference external" href="https://www.carbonbrief.org/cmip6-the-next-generation-of-climate-models-explained/">equilibrium climate sensitivity towards the higher end of the CMIP6 spectrum</a>. As mentioned, we’ll later expand this analysis to include multiple CMIP6 models.</p>
<p>Now we must specify our <strong>climate indicator</strong> - the way we’ll quantify AC loads as a function of climatic variables. A standard climate indicator that was developed to be a proxy for AC loads is <strong>Cooling Degree Days</strong> (CDDs). CDDs measure the cumulative annual AC load by summing the amount by which the daily mean temperature exceeds a certain threshold, on days when that threshold is exceeded. The formula is as follows:</p>
<div class="math notranslate nohighlight">
\[
CDD = \sum_{i=1}^{365}\left(T_{i} - T_{thresh}\right) I\left(T_{i} &gt; T_{thresh} \right)
\]</div>
<p>Where <span class="math notranslate nohighlight">\(I(x)\)</span> is the indicator function, taking value 1 when <span class="math notranslate nohighlight">\(x\)</span> is true and <span class="math notranslate nohighlight">\(0\)</span> when <span class="math notranslate nohighlight">\(x\)</span> is false. The usual value for <span class="math notranslate nohighlight">\(T_{thresh}\)</span> is 18<span class="math notranslate nohighlight">\(^{\circ}\)</span>C. Remember that <span class="math notranslate nohighlight">\(T_{i}\)</span> is the <em>daily mean</em> temperature. You may not usually turn on your AC when the temperature is 18<span class="math notranslate nohighlight">\(^{\circ}\)</span>C, but the peak afternoon temperature on such a day is likely to be much warmer than 18<span class="math notranslate nohighlight">\(^{\circ}\)</span>C because of the diurnal cycle.</p>
<p>Knowing how to calculate CDDs has answered the next few survey questions for us: the input variable is <strong>surface air temperature</strong>, with the time sampling being <strong>daily averages</strong>.</p>
<p>Finally, we must specify the spatial sampling for our data. In this example, we’re interested in projections for a single discrete location: the site of an <strong>ECCC weather station</strong> from which we’ll draw observations of daily mean temperature. As mentioned, a later example will use gridded observations to produce downscaled results for an extended region, but this first example will start simple and demonstrate the workflow for a small case.</p>
<p>Having answered all of the survey questions, we can use the UTCDW website to generate a flowchart that explains the steps of our analysis:</p>
<a class="reference internal image-reference" href="../_images/survey_station_cesm2.png"><img alt="../_images/survey_station_cesm2.png" class="align-center" src="../_images/survey_station_cesm2.png" style="width: 600px;" /></a>
<p>The top half of the flowchart contains the answers to the survey questions, regarding the data we’ve chosen to use. These decisions feed into the analysis steps on the bottom half of the flowchart, which is standardized. Of course, there remain decisions to be made regarding the important aspects of the model data to validate, and your method of bias-correction/downscaling, but these can be dealt with after having decided on which datasets to use and may become more apparent after doing exploratory analysis with the data.</p>
</div>
<div class="section" id="selecting-and-downloading-the-datasets">
<h2>6.1.2 Selecting and Downloading the Datasets<a class="headerlink" href="#selecting-and-downloading-the-datasets" title="Permalink to this heading">#</a></h2>
<p>Having decided on the scope of the project, and some details that constrain the datasets that will be used in the study, we can start acquiring the data. Let’s begin with the observational dataset: ECCC weather station observations for a single site in Edmonton. We will use the <code class="docutils literal notranslate"><span class="pre">ec3</span></code> package to search for an appropriate station and download the data. Then we’ll do some data cleaning with <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, and eventually convert the station data into <code class="docutils literal notranslate"><span class="pre">xarray</span></code> format so it can be processed in the same way as the model data, and be used with <code class="docutils literal notranslate"><span class="pre">xclim</span></code> for bias correction and calculating the climate indicator.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">xclim</span> <span class="kn">import</span> <span class="n">sdba</span>
<span class="kn">from</span> <span class="nn">xclim.core.calendar</span> <span class="kn">import</span> <span class="n">convert_calendar</span>
<span class="kn">import</span> <span class="nn">xclim.indices</span> <span class="k">as</span> <span class="nn">xci</span>
<span class="kn">import</span> <span class="nn">xclim.ensembles</span> <span class="k">as</span> <span class="nn">xce</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">ec3</span>
<span class="kn">import</span> <span class="nn">gcsfs</span>
<span class="kn">import</span> <span class="nn">zarr</span>

<span class="c1"># lat and lon coordinates for Edmonton</span>
<span class="n">lat_edm</span> <span class="o">=</span> <span class="mf">53.5</span>
<span class="n">lon_edm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">113.5</span>

<span class="c1"># time periods for historical and future periods</span>
<span class="n">years_hist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">2011</span><span class="p">)</span> <span class="c1"># remember that range(start, end) is not inclusive of `end`</span>
<span class="n">years_future</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2070</span><span class="p">,</span> <span class="mi">2101</span><span class="p">)</span>

<span class="c1"># url for the CSV file that contains the data catalog</span>
<span class="n">url_gcsfs_catalog</span> <span class="o">=</span> <span class="s1">&#39;https://storage.googleapis.com/cmip6/cmip6-zarr-consolidated-stores.csv&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># search for stations near our desired location</span>
<span class="n">find_stn_results</span> <span class="o">=</span> <span class="n">ec3</span><span class="o">.</span><span class="n">find_station</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_edm</span><span class="p">,</span> <span class="n">lon_edm</span><span class="p">),</span> 
                                    <span class="n">period</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">2011</span><span class="p">),</span>
                                    <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span>
                                    <span class="n">dist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
                                    <span class="n">detect_recodes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/mikemorris/opt/anaconda3/envs/UTCDW-env/lib/python3.10/site-packages/ec3.py:105: UserWarning: Cannot find the station inventory in the current working directory.
  warnings.warn(&quot;Cannot find the station inventory in the current working directory.&quot;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading Station Inventory EN.csv to /var/folders/nt/0d8x2n0x1bdbrmp50m9nn6f00000gn/T/tmplr0ssqzc
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: In addition to the stations found, the following combinations may provide sufficient baseline data.


&gt;&gt; Combination 1 at coordinates 53.57 -113.52 

Station 1864 : EDMONTON CALDER (1975-1977)
Station 1867 : EDMONTON CITY CENTRE A (1937-2005)
Station 27214 : EDMONTON BLATCHFORD (1996-2023)
Station 31427 : EDMONTON CITY CENTRE AWOS (2005-2015)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">find_stn_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>Province</th>
      <th>Climate ID</th>
      <th>Station ID</th>
      <th>WMO ID</th>
      <th>TC ID</th>
      <th>Latitude (Decimal Degrees)</th>
      <th>Longitude (Decimal Degrees)</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Elevation (m)</th>
      <th>First Year</th>
      <th>Last Year</th>
      <th>DLY First Year</th>
      <th>DLY Last Year</th>
      <th>Dist</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2429</th>
      <td>EDMONTON WOODBEND</td>
      <td>ALBERTA</td>
      <td>3012230</td>
      <td>1872</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>53.42</td>
      <td>-113.75</td>
      <td>532500000.0</td>
      <td>-1.134500e+09</td>
      <td>670.6</td>
      <td>1973</td>
      <td>2015</td>
      <td>1973.0</td>
      <td>2015.0</td>
      <td>18.84175793351712 km</td>
    </tr>
    <tr>
      <th>2416</th>
      <td>EDMONTON INT'L A</td>
      <td>ALBERTA</td>
      <td>3012205</td>
      <td>1865</td>
      <td>71123.0</td>
      <td>YEG</td>
      <td>53.32</td>
      <td>-113.58</td>
      <td>531900000.0</td>
      <td>-1.133500e+09</td>
      <td>723.3</td>
      <td>1959</td>
      <td>2012</td>
      <td>1959.0</td>
      <td>2012.0</td>
      <td>20.72726507003484 km</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</details>
</div>
<p>To focus on an urban area where any change to CDDs is likely to have the most impact on people and building energy use, we’ll use the Edmonton City Centre station. This means combining data from Station IDs 1867 and 31427, to fit our whole historical reference period.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download_station_data</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1992</span><span class="p">,</span> <span class="mi">2022</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download ECCC observational data at the weather station identified with stn_id,</span>
<span class="sd">    re-name the columns to more useful names. Optional: select specific years of data,</span>
<span class="sd">    but by default, download all data from 1990--2020.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># download the data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ec3</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">years</span> <span class="o">=</span> <span class="n">years</span><span class="p">,</span> <span class="n">progress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># dictionary mapping original column names to new ones</span>
    <span class="n">column_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date/Time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;Mean Temp (°C)&#39;</span><span class="p">:</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Latitude (y)&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Longitude (x)&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Station Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">}</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">column_name_dict</span><span class="p">)</span>
    
    <span class="c1"># select only the variables we re-named - you can comment this out if you want to keep all variables</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">column_name_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
    
    <span class="c1"># set the &quot;time&quot; column as an index column and convert it from strings to Datetime objects to make</span>
    <span class="c1"># selecting times easier</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    
    <span class="c1"># sort the data in proper chronological order</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the station data</span>
<span class="n">stn_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1867</span><span class="p">,</span> <span class="mi">31427</span><span class="p">]</span>
<span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">stn_id</span> <span class="ow">in</span> <span class="n">stn_id_list</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">download_station_data</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="n">years</span> <span class="o">=</span> <span class="n">years_hist</span><span class="p">)</span>
    <span class="c1"># print first and last timestep so we can check if there is any time overlap</span>
    <span class="c1"># between the two records</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;start: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;end: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1867 start: 1980-01-01T00:00:00.000000000 end: 2005-01-20T00:00:00.000000000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>31427 start: 2005-01-21T00:00:00.000000000 end: 2010-12-31T00:00:00.000000000
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the above output shows no overlap in time between the two stations, so we can safely</span>
<span class="c1"># concatenate them without dropping any data from one or the other</span>
<span class="n">stn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># now convert it to xarray format for easier use with the model data and xclim</span>

<span class="c1"># drop lat and lon variables, since we want these to be coordinates in the xr.Dataset</span>
<span class="n">stn_lon</span> <span class="o">=</span> <span class="n">stn_df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span> <span class="c1"># convert lon to same convention as model data</span>
<span class="n">stn_lat</span> <span class="o">=</span> <span class="n">stn_df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 

<span class="n">stn_df</span> <span class="o">=</span> <span class="n">stn_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">stn_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">stn_df</span><span class="p">)</span>
<span class="n">stn_ds</span> <span class="o">=</span> <span class="n">stn_ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="n">stn_lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">stn_lon</span><span class="p">)</span>
<span class="n">stn_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:  (time: 11214)
Coordinates:
  * time     (time) datetime64[ns] 1980-01-01 1980-01-02 ... 2010-12-31
    lat      float64 53.57
    lon      float64 246.5
Data variables:
    tas      (time) float64 -9.4 -5.8 -10.3 -11.8 ... -11.0 -17.6 -18.0 -19.0
    Name     (time) object &#x27;EDMONTON CITY CENTRE A&#x27; ... &#x27;EDMONTON CITY CENTRE...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-52ff8a78-10c7-4948-a868-475112982d38' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-52ff8a78-10c7-4948-a868-475112982d38' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>time</span>: 11214</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-575a6920-61d0-4057-bef1-05d877c62c36' class='xr-section-summary-in' type='checkbox'  checked><label for='section-575a6920-61d0-4057-bef1-05d877c62c36' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1980-01-01 ... 2010-12-31</div><input id='attrs-84a4575a-9426-49bf-8ec4-4c101fa94b76' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-84a4575a-9426-49bf-8ec4-4c101fa94b76' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1d9da649-38fb-4610-b3c2-397de2b90f11' class='xr-var-data-in' type='checkbox'><label for='data-1d9da649-38fb-4610-b3c2-397de2b90f11' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;1980-01-01T00:00:00.000000000&#x27;, &#x27;1980-01-02T00:00:00.000000000&#x27;,
       &#x27;1980-01-03T00:00:00.000000000&#x27;, ..., &#x27;2010-12-29T00:00:00.000000000&#x27;,
       &#x27;2010-12-30T00:00:00.000000000&#x27;, &#x27;2010-12-31T00:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>lat</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>53.57</div><input id='attrs-31f779dc-77a7-4a6c-acab-ebd126387a6f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-31f779dc-77a7-4a6c-acab-ebd126387a6f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-8b4d2214-a2dc-45ce-861a-33195734e2b2' class='xr-var-data-in' type='checkbox'><label for='data-8b4d2214-a2dc-45ce-861a-33195734e2b2' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array(53.57)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>lon</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>246.5</div><input id='attrs-9af5d1ea-2e5e-4557-af88-6030347e6062' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9af5d1ea-2e5e-4557-af88-6030347e6062' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-659c32a2-853d-4284-a9f0-66c0f0967c32' class='xr-var-data-in' type='checkbox'><label for='data-659c32a2-853d-4284-a9f0-66c0f0967c32' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array(246.48)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-f0517933-e1b1-4d4b-8e7f-de59c4a85ca2' class='xr-section-summary-in' type='checkbox'  checked><label for='section-f0517933-e1b1-4d4b-8e7f-de59c4a85ca2' class='xr-section-summary' >Data variables: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>tas</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>-9.4 -5.8 -10.3 ... -18.0 -19.0</div><input id='attrs-33761d18-b231-4a2b-8d1f-9f2c97ee01ed' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-33761d18-b231-4a2b-8d1f-9f2c97ee01ed' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-433da03a-e333-4194-9df7-fd9a25f2d121' class='xr-var-data-in' type='checkbox'><label for='data-433da03a-e333-4194-9df7-fd9a25f2d121' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([ -9.4,  -5.8, -10.3, ..., -17.6, -18. , -19. ])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>Name</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;EDMONTON CITY CENTRE A&#x27; ... &#x27;ED...</div><input id='attrs-d9e857fc-8935-4d70-9bd6-ed79ccb1f1e8' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d9e857fc-8935-4d70-9bd6-ed79ccb1f1e8' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-afa5a370-967f-4287-95a1-d46aa16670cc' class='xr-var-data-in' type='checkbox'><label for='data-afa5a370-967f-4287-95a1-d46aa16670cc' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;EDMONTON CITY CENTRE A&#x27;, &#x27;EDMONTON CITY CENTRE A&#x27;,
       &#x27;EDMONTON CITY CENTRE A&#x27;, ..., &#x27;EDMONTON CITY CENTRE AWOS&#x27;,
       &#x27;EDMONTON CITY CENTRE AWOS&#x27;, &#x27;EDMONTON CITY CENTRE AWOS&#x27;],
      dtype=object)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-cb3e2d5c-4f97-4cb0-8ae8-60d98428691b' class='xr-section-summary-in' type='checkbox'  ><label for='section-cb3e2d5c-4f97-4cb0-8ae8-60d98428691b' class='xr-section-summary' >Indexes: <span>(1)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-0020bf24-3f4a-448a-9987-5ad39818a2d7' class='xr-index-data-in' type='checkbox'/><label for='index-0020bf24-3f4a-448a-9987-5ad39818a2d7' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;1980-01-01&#x27;, &#x27;1980-01-02&#x27;, &#x27;1980-01-03&#x27;, &#x27;1980-01-04&#x27;,
               &#x27;1980-01-05&#x27;, &#x27;1980-01-06&#x27;, &#x27;1980-01-07&#x27;, &#x27;1980-01-08&#x27;,
               &#x27;1980-01-09&#x27;, &#x27;1980-01-10&#x27;,
               ...
               &#x27;2010-12-22&#x27;, &#x27;2010-12-23&#x27;, &#x27;2010-12-24&#x27;, &#x27;2010-12-25&#x27;,
               &#x27;2010-12-26&#x27;, &#x27;2010-12-27&#x27;, &#x27;2010-12-28&#x27;, &#x27;2010-12-29&#x27;,
               &#x27;2010-12-30&#x27;, &#x27;2010-12-31&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, length=11214, freq=None))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-68b647ef-ac31-4c57-af5c-25c6c4f0c1a3' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-68b647ef-ac31-4c57-af5c-25c6c4f0c1a3' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</details>
</div>
<p>Having downloaded the station observational data, the next step is to download the raw model data. Since it tends to be more reliable than the ESGF, we’ll search the Google Cloud Services CMIP6 archive for data from our chosen model and scenarios.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># open the Google Cloud model data catalog with pandas</span>
<span class="n">df_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url_gcsfs_catalog</span><span class="p">)</span>

<span class="c1"># search for our selected model, both historical and SSP3-7.0 scenarios</span>
<span class="n">search_string</span> <span class="o">=</span> <span class="s2">&quot;table_id == &#39;day&#39; &amp; source_id == &#39;CESM2&#39; &amp; variable_id == &#39;tas&#39;&quot;</span> <span class="c1"># continue on the next line</span>
<span class="n">search_string</span> <span class="o">+=</span> <span class="s2">&quot; &amp; experiment_id == [&#39;historical&#39;, &#39;ssp370&#39;]&quot;</span>
<span class="n">df_search</span> <span class="o">=</span> <span class="n">df_catalog</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">search_string</span><span class="p">)</span>

<span class="c1"># print a summary of the resulting dataframe, click to reveal</span>
<span class="n">df_search</span> 
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>activity_id</th>
      <th>institution_id</th>
      <th>source_id</th>
      <th>experiment_id</th>
      <th>member_id</th>
      <th>table_id</th>
      <th>variable_id</th>
      <th>grid_label</th>
      <th>zstore</th>
      <th>dcpp_init_year</th>
      <th>version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>58919</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r1i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r1...</td>
      <td>NaN</td>
      <td>20190308</td>
    </tr>
    <tr>
      <th>61527</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r5i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r5...</td>
      <td>NaN</td>
      <td>20190308</td>
    </tr>
    <tr>
      <th>61604</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r4i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r4...</td>
      <td>NaN</td>
      <td>20190308</td>
    </tr>
    <tr>
      <th>61627</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r3i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r3...</td>
      <td>NaN</td>
      <td>20190308</td>
    </tr>
    <tr>
      <th>62145</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r6i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r6...</td>
      <td>NaN</td>
      <td>20190308</td>
    </tr>
    <tr>
      <th>63061</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r2i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r2...</td>
      <td>NaN</td>
      <td>20190308</td>
    </tr>
    <tr>
      <th>64025</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r7i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r7...</td>
      <td>NaN</td>
      <td>20190311</td>
    </tr>
    <tr>
      <th>65331</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r9i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r9...</td>
      <td>NaN</td>
      <td>20190311</td>
    </tr>
    <tr>
      <th>65878</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r8i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r8...</td>
      <td>NaN</td>
      <td>20190311</td>
    </tr>
    <tr>
      <th>66385</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r10i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r1...</td>
      <td>NaN</td>
      <td>20190313</td>
    </tr>
    <tr>
      <th>200863</th>
      <td>CMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>historical</td>
      <td>r11i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/CMIP/NCAR/CESM2/historical/r1...</td>
      <td>NaN</td>
      <td>20190514</td>
    </tr>
    <tr>
      <th>445868</th>
      <td>ScenarioMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>ssp370</td>
      <td>r10i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/ScenarioMIP/NCAR/CESM2/ssp370...</td>
      <td>NaN</td>
      <td>20200528</td>
    </tr>
    <tr>
      <th>446463</th>
      <td>ScenarioMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>ssp370</td>
      <td>r11i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/ScenarioMIP/NCAR/CESM2/ssp370...</td>
      <td>NaN</td>
      <td>20200528</td>
    </tr>
    <tr>
      <th>446493</th>
      <td>ScenarioMIP</td>
      <td>NCAR</td>
      <td>CESM2</td>
      <td>ssp370</td>
      <td>r4i1p1f1</td>
      <td>day</td>
      <td>tas</td>
      <td>gn</td>
      <td>gs://cmip6/CMIP6/ScenarioMIP/NCAR/CESM2/ssp370...</td>
      <td>NaN</td>
      <td>20200528</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</details>
</div>
<p>Because it has simulations available for both the <code class="docutils literal notranslate"><span class="pre">historical</span></code> and <code class="docutils literal notranslate"><span class="pre">ssp370</span></code> experiments, we’ll start with the ensemble member <code class="docutils literal notranslate"><span class="pre">r10i1p1f1</span></code>. For this ensemble member of CESM2, we’ll download the <code class="docutils literal notranslate"><span class="pre">tas</span></code> data from Google Cloud, interpolate it to the coordinates of our station, and select the time periods for the study. For the historical scenario, this will be 1980–2010, the same time period we chose for the station observations. For the future period, we’ll use an end-of-century period, 2070-2100.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filter the search results further for the ensemble member we want to use</span>
<span class="n">df_search_r10i1p1f1</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;member_id == &#39;r10i1p1f1&#39;&quot;</span><span class="p">)</span>

<span class="c1"># authenticate access to Google Cloud</span>
<span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="s1">&#39;anon&#39;</span><span class="p">)</span>

<span class="c1"># get the URLs for each dataset and turn into zarr store mappers</span>
<span class="n">url_hist</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;historical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_hist</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_hist</span><span class="p">)</span>
<span class="n">url_ssp3</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;ssp370&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_ssp3</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_ssp3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the datasets and interpolate data to the station coordinates</span>

<span class="c1"># historical</span>
<span class="n">ds_hist_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_hist</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_hist_raw</span> <span class="o">=</span> <span class="n">ds_hist_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="n">stn_lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">stn_lon</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># also convert to C</span>

<span class="c1"># future</span>
<span class="n">ds_ssp3_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_ssp3</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_ssp3_raw</span> <span class="o">=</span> <span class="n">ds_ssp3_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="n">stn_lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">stn_lon</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span> 

<span class="c1"># select time periods</span>
<span class="n">tas_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_hist</span><span class="p">))</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">tas_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_future</span><span class="p">))</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</div>
<div class="section" id="assessing-model-obs-consistency">
<h2>6.1.3 Assessing Model-Obs Consistency<a class="headerlink" href="#assessing-model-obs-consistency" title="Permalink to this heading">#</a></h2>
<p>Now that we’ve acquired the model data for our study location, and for the right time periods, we can take a peek at the data and compare the raw model simulations to the observations. This will help us characterize the bias in the raw historical simulations, plus the climate change signal in the raw model projections relative to the historical simulation. First let’s plot the daily climatologies for each dataset, all on the same axes.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate daily climatologies</span>

<span class="c1"># station</span>
<span class="n">tas_dailyclim_obs</span> <span class="o">=</span> <span class="n">stn_ds</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_dailyclim_std_obs</span> <span class="o">=</span> <span class="n">stn_ds</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># raw historical</span>
<span class="n">tas_dailyclim_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_dailyclim_std_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot daily climatologies for historical simulation and obs</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># daily climatologies as 1D curves</span>
<span class="n">tas_dailyclim_obs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Station Obs&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">tas_dailyclim_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw Historical&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>

<span class="c1"># 1 sigma shading</span>

<span class="c1"># obs</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_obs</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span>
                <span class="n">tas_dailyclim_obs</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_obs</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_obs</span> <span class="o">+</span> <span class="n">tas_dailyclim_std_obs</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="c1"># raw historical</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_hist_raw</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_hist_raw</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_hist_raw</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_hist_raw</span>  <span class="o">+</span> <span class="n">tas_dailyclim_std_hist_raw</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edmonton Daily Mean Temperature Daily Climatology&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/be78089ef0cb49539363557a53dc2c1aa0e7ec50f3a68a6ef1186307c371267c.png" src="../_images/be78089ef0cb49539363557a53dc2c1aa0e7ec50f3a68a6ef1186307c371267c.png" />
</div>
</div>
<p>Strange, the observed data drops to a very low value at the end of the year and extends past the model data on the x axis. This is because the model calendar does not include leap years! To account for this discrepancy, we will drop leap days from the station data to rectify the difference in calendars, and then re-do the calculation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate station daily climatology again after converting its calendar to match the model</span>
<span class="n">stn_ds_noleap</span> <span class="o">=</span> <span class="n">convert_calendar</span><span class="p">(</span><span class="n">stn_ds</span><span class="p">,</span> <span class="s1">&#39;noleap&#39;</span><span class="p">)</span>
<span class="n">tas_obs_noleap</span> <span class="o">=</span> <span class="n">stn_ds_noleap</span><span class="o">.</span><span class="n">tas</span>

<span class="n">tas_dailyclim_obs</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_dailyclim_std_obs</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot daily climatologies for historical simulation and obs</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># daily climatologies as 1D curves</span>
<span class="n">tas_dailyclim_obs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Station Obs&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">tas_dailyclim_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw Historical&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>

<span class="c1"># 1 sigma shading</span>

<span class="c1"># obs</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_obs</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span>
                <span class="n">tas_dailyclim_obs</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_obs</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_obs</span> <span class="o">+</span> <span class="n">tas_dailyclim_std_obs</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="c1"># raw historical</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_hist_raw</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_hist_raw</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_hist_raw</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_hist_raw</span>  <span class="o">+</span> <span class="n">tas_dailyclim_std_hist_raw</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edmonton Daily Mean Temperature Daily Climatology&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/45584cf562390f8cc41f37498bc6180db1f9918de58bd525ae0554a8993956bb.png" src="../_images/45584cf562390f8cc41f37498bc6180db1f9918de58bd525ae0554a8993956bb.png" />
</div>
</div>
<p>This second plot is a more fair comparison of the daily climatologies. The model bias for this location (i.e. the difference between the obs and the historical simulation) isn’t especially large in this case, which is encouraging. The daily climatoloies do not agree perfectly, most notably in the summertime when the model historical climatology peaks later in the year than the observed climatology, but the one-standard-deviation (one-<span class="math notranslate nohighlight">\(\sigma\)</span>) ranges overlap a lot. We’ll continue to characterize the model bias in the next step by plotting the PDFs and CDFs of daily mean temperature for both datasets.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit Kernel Density Estimator so we can plot a smooth distribution</span>
<span class="n">kde_hist_raw</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">kde_obs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> 

<span class="c1"># means and stdev ratios</span>
<span class="n">tas_hist_raw_mean</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_obs_mean</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># stdevs for each dataset</span>
<span class="n">tas_hist_raw_stdev</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_obs_stdev</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the PDFs smoothed by KDE</span>
<span class="n">temperatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Edmonton Daily Mean Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_obs</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Station Obs&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_hist_raw</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CESM2 Raw Historical&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">([</span><span class="n">tas_hist_raw_mean</span><span class="p">,</span> <span class="n">tas_obs_mean</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># annotate with mean bias and ratio of stdevs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mf">0.038</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Mean Bias: </span><span class="si">%.2f</span><span class="s1"> $^{\circ}$C&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tas_hist_raw_mean</span> <span class="o">-</span> <span class="n">tas_obs_mean</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Stdev Ratio: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tas_hist_raw_stdev</span> <span class="o">/</span> <span class="n">tas_obs_stdev</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/bcae2b8ccd284e982d0b2089242631c440f58cbeac4f0a3525bcb7968f2cefe5.png" src="../_images/bcae2b8ccd284e982d0b2089242631c440f58cbeac4f0a3525bcb7968f2cefe5.png" />
</div>
</div>
<p>This situation is similar to Section 3.4.4 where we compared the temperature distributions for Toronto between CanESM5 and the Toronto City ECCC station. Here the mean bias is small and the overall variability is similar, but the model (CESM2) distribution is sharply bimodal while the observed temperature distribution is less so. This feature of the bias in the model temperatures cannot be determined by comparing the daily climatologies, but it’s important to account for. Thankfully, our quantile mapping based bias correction methods (like Quantile Delta Mapping) can help correct this. Later on, we’ll reproduce this plot with bias-corrected model data to see if it helps correct for the spurious bimodality of the daily mean temperature distribution.</p>
<p>The next thing to check in regards to model/obs agreement is our climate indicator, cooling degree days (CDDs).  If your indicator requires high spatial resolution to calculate (e.g. if you need high-resolution inputs for a complex impacts model), then you won’t be able to do this step. Because CDDs are calculated using a simple formula and this can be calculated from a 1D timeseries of daily mean temperature, there’s no reason why we can’t compare the results from the raw model output to the observed values. We will use the standard temperature threshold of 18<span class="math notranslate nohighlight">\(^{\circ}\)</span>C in our calculation of CDDs (which is the default for <code class="docutils literal notranslate"><span class="pre">xclim.indices.cooling_degree_days</span></code>).</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add unit attributes to tas data for use with xclim routines</span>
<span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>
<span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs</span>
<span class="n">cdd_obs</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_obs_noleap</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_hist_raw</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_hist_raw</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term means for the historical period</span>
<span class="n">cdd_obs_ltm</span> <span class="o">=</span> <span class="n">cdd_obs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_hist_raw_ltm</span> <span class="o">=</span> <span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot timeseries of CDDs for model historical and obs</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">cdd_obs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Station Obs (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw Historical (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>

<span class="c1"># plot long-term means</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> 
          <span class="n">cdd_obs</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_obs</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
          <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edmonton Cooling Degree Days&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;CDD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># show the mean bias on the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cdd_obs</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="s2">&quot;Mean Bias: </span><span class="si">%.1f</span><span class="s2"> CDDs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/bd8e6ab2c3d0741cd4f21571b65422616b0afbd33fa8464b30a62a49c2884e2b.png" src="../_images/bd8e6ab2c3d0741cd4f21571b65422616b0afbd33fa8464b30a62a49c2884e2b.png" />
</div>
</div>
<p>Despite good agreement regarding the daily climatology and the overall mean and standard deviation, the model shows a fairly sizable bias in the number of annual CDDs. 13 CDDs per year, compared to the observed long-term mean of about 86 CDDs per year, is a mean bias of about 15%. Going through the exercise of calculating the climate indicator using the raw model data has illuminated this important bias, which wouldn’t be easily deduced by examining the previous plots. The spurious low-temperature peak of the model PDF hints that there may be too few warm days, but we couldn’t make this conclusion without calculating the CDDs.</p>
</div>
<div class="section" id="evaluating-the-climate-change-signal">
<h2>6.1.4 Evaluating the Climate Change Signal<a class="headerlink" href="#evaluating-the-climate-change-signal" title="Permalink to this heading">#</a></h2>
<p>Having characterized the model bias using the historical simulation and the observations, it is time to evaluate the climate change projections of the raw model simulations. First, we will plot the daily climatology of the SSP3-7.0 end-of-century projections, and compare it to the historical period model daily climatology.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># daily climatology for raw SSP3-7.0</span>
<span class="n">tas_dailyclim_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_dailyclim_std_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot daily climatologies for both model simulations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># daily climatologies as 1D curves</span>
<span class="n">tas_dailyclim_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw Historical&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">tas_dailyclim_ssp3_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw SSP3-7.0&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>

<span class="c1"># 1 sigma shading</span>
<span class="c1"># raw historical</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_hist_raw</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_hist_raw</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_hist_raw</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_hist_raw</span>  <span class="o">+</span> <span class="n">tas_dailyclim_std_hist_raw</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="c1"># raw SSP3-7.0</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_ssp3_raw</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_ssp3_raw</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_ssp3_raw</span><span class="p">,</span>
                <span class="n">tas_dailyclim_ssp3_raw</span> <span class="o">+</span> <span class="n">tas_dailyclim_std_ssp3_raw</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edmonton Daily Mean Temperature Daily Climatology&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/c5c29a5de8d3f6c74054fab0b84236e49bc0e8027c147fdc0f04545bb674fcf0.png" src="../_images/c5c29a5de8d3f6c74054fab0b84236e49bc0e8027c147fdc0f04545bb674fcf0.png" />
</div>
</div>
<p>We see clear signs of warming in the end-of-century period under the SSP3-7.0 scenario, especially in the summer season. The low end of the one-<span class="math notranslate nohighlight">\(\sigma\)</span> range for this case is completely above the high end of the variability range for the model historical case. This is likely to result in large changes in our climate indicator, cooling degree days.</p>
<p>Before calculating the change in CDDs for the raw model output, let’s first test the statistical significance of the climate change signal, using the methods from Section 3.4.5.1. We’ll use the Students’ <span class="math notranslate nohighlight">\(t\)</span>-test, with correction for temporal autocorrelation, to test for an increase in the mean temperature.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate mean and stdev for future</span>
<span class="n">tas_ssp3_raw_mean</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">tas_ssp3_raw_stdev</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate effective sample size for historical and future periods</span>
<span class="k">def</span> <span class="nf">effective_sample_size</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">ntime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="c1"># times not including the final timestep</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntime</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># data not including the first timestep</span>
    <span class="n">data_lag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntime</span><span class="p">))</span>
    <span class="c1"># match up time values, otherwise the xr.corr function won&#39;t return the correct output</span>
    <span class="n">data_lag</span> <span class="o">=</span> <span class="n">data_lag</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">times</span><span class="p">)</span>
    
    <span class="c1"># calculate correlation</span>
    <span class="n">autocor</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">times</span><span class="p">),</span>
                      <span class="n">data_lag</span><span class="p">,</span>
                      <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
    
    <span class="n">neff</span> <span class="o">=</span> <span class="n">ntime</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">autocor</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">autocor</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">neff</span>

<span class="n">neff_hist_raw</span> <span class="o">=</span> <span class="n">effective_sample_size</span><span class="p">(</span><span class="n">tas_hist_raw</span><span class="p">)</span>
<span class="n">neff_ssp3_raw</span> <span class="o">=</span> <span class="n">effective_sample_size</span><span class="p">(</span><span class="n">tas_ssp3_raw</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># perform two_sample t-test to see if future temperatures are higher than past</span>
<span class="n">tstat</span><span class="p">,</span> <span class="n">pval_neff</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind_from_stats</span><span class="p">(</span><span class="n">tas_hist_raw_mean</span><span class="p">,</span>
                                              <span class="n">tas_hist_raw_stdev</span><span class="p">,</span>
                                              <span class="n">neff_hist_raw</span><span class="p">,</span> <span class="c1"># effective sample size </span>
                                              <span class="n">tas_ssp3_raw_mean</span><span class="p">,</span> 
                                              <span class="n">tas_ssp3_raw_stdev</span><span class="p">,</span> 
                                              <span class="n">neff_ssp3_raw</span><span class="p">,</span>
                                              <span class="n">equal_var</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                              <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;less&#39;</span><span class="p">)</span> 
<span class="c1"># alt hypothesis is that the first dataset (historical) has a lower mean than the second dataset (future)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;p-value for t-test: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pval_neff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>p-value for t-test: 0.0001
</pre></div>
</div>
</div>
</div>
<p>The low <span class="math notranslate nohighlight">\(p\)</span>-value for our test means we can reject the null hypothesis of no change, and conclude that the warming signal in the SSP3-7.0 end-of-century period is statistically significant. Next let’s calculate the future projected CDDs and do a similar test, to assess the significance of changes to CDDs in the raw model data.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add unit attributes to tas data for use with xclim routines</span>
<span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs</span>
<span class="n">cdd_ssp3_raw</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_ssp3_raw</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term means</span>
<span class="n">cdd_ssp3_raw_ltm</span> <span class="o">=</span> <span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># stdevs for historical and ssp3</span>
<span class="n">cdd_hist_raw_stdev</span> <span class="o">=</span> <span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_ssp3_raw_stdev</span> <span class="o">=</span> <span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot timeseries of annual CDDs for the raw model data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw Historical (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw SSP3-7.0 (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_ssp3_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>

<span class="c1"># plot long-term means</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">cdd_ssp3_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> 
          <span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
          <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edmonton Cooling Degree Days&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;CDD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># show the mean change on the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="s2">&quot;Mean Change: </span><span class="si">%.1f</span><span class="s2"> CDDs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdd_ssp3_raw_ltm</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f53940c903ef641463cd771ae48e58e27373b64e19296c36c17451265d48c651.png" src="../_images/f53940c903ef641463cd771ae48e58e27373b64e19296c36c17451265d48c651.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># perform two_sample t-test to see if the future period has more CDDs</span>
<span class="n">tstat</span><span class="p">,</span> <span class="n">pval_cdds</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind_from_stats</span><span class="p">(</span><span class="n">cdd_hist_raw_ltm</span><span class="p">,</span>
                                              <span class="n">cdd_hist_raw_stdev</span><span class="p">,</span>
                                              <span class="nb">len</span><span class="p">(</span><span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="c1"># different years should be indep. of each other</span>
                                              <span class="n">cdd_ssp3_raw_ltm</span><span class="p">,</span>
                                              <span class="n">cdd_ssp3_raw_stdev</span><span class="p">,</span>
                                              <span class="nb">len</span><span class="p">(</span><span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                                              <span class="n">equal_var</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                              <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;less&#39;</span><span class="p">)</span> 
<span class="c1"># alt hypothesis is that the first dataset (historical) has a lower mean than the second dataset (future)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;p-value for t-test: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pval_cdds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>p-value for t-test: 0.0000
</pre></div>
</div>
</div>
</div>
<p>Wow! The raw model projects an enormous increase in annual CDDs, as we suspected based on the large increase in mean summertime temperatures. This should establish our baseline expectation for what to see in the bias-corrected projections. The exact change may be different, but because we are using a univariate method, we should still see a large increase in CDDs for the future scenario.</p>
</div>
<div class="section" id="applying-the-bias-correction">
<h2>6.1.5 Applying the Bias Correction<a class="headerlink" href="#applying-the-bias-correction" title="Permalink to this heading">#</a></h2>
<p>In this example, we will use Quantile Delta Mapping (QDM, <span id="id1">Cannon <em>et al.</em> [<a class="reference internal" href="../guidebook_references.html#id6" title="Alex J. Cannon, Stephen R. Sobie, and Trevor Q. Murdock. Bias Correction of GCM Precipitation by Quantile Mapping: How Well Do Methods Preserve Changes in Quantiles and Extremes? Journal of Climate, 28(17):6938–6959, September 2015. URL: http://journals.ametsoc.org/doi/10.1175/JCLI-D-14-00754.1 (visited on 2022-12-06), doi:10.1175/JCLI-D-14-00754.1.">2015</a>]</span> and Section 4.2.3.3) as the method for bias correction. Since we are using data only for a single location, there is no true “downscaling” involved, as the spatial sampling of the results will be the same as the inputs - a 1D timeseries. This bias-correction method is preferred because it corrects for biases in all quantiles of the distribution of the variable of interest <em>and</em> preserves the model-projected relative changes in the entire distribution as well. The former is true for any quantile-mapping based bias-correction method (such as EQM, Section 4.2.3.1), but the latter is the defining feature of QDM. This makes it particularly good for handling changes to extreme values (i.e. high and low quantiles of the distribution), as opposed to other methods which preserve only the mean change projected by the model.</p>
<p><code class="docutils literal notranslate"><span class="pre">xclim.sdba</span></code> has implemented the QDM method with the class <code class="docutils literal notranslate"><span class="pre">xclim.sdba.adjustment.QuantileDeltaMapping</span></code> (<a class="reference external" href="https://xclim.readthedocs.io/en/stable/xclim.sdba.html#xclim.sdba.adjustment.QuantileDeltaMapping">documentation</a>). All of the classes in <code class="docutils literal notranslate"><span class="pre">xclim.sdba.adjust</span></code> have a <code class="docutils literal notranslate"><span class="pre">.train</span></code> method, which fits the quantiles and calculates the adjustment factors, and a <code class="docutils literal notranslate"><span class="pre">.adjust</span></code> method, which applies the bias correction to the provided <code class="docutils literal notranslate"><span class="pre">xr.DataArray</span></code>. The content herein will try to demonstrate how to use this package, but you should also take the time to review the documentation for the adjustment method, plus their generic <a class="reference external" href="https://xclim.readthedocs.io/en/stable/notebooks/sdba.html">examples</a> of how to use <code class="docutils literal notranslate"><span class="pre">xclim.sdba</span></code>, before proceeding. You should also review the tips for applying bias-correction methods provided in Section 5.4.2 of this Guidebook.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># xclim&#39;s QM methods don&#39;t allow chunking along the time dimension,</span>
<span class="c1"># so this will re-chunk the data to a single chunk along the time dimension</span>
<span class="n">tas_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># estimate the quantiles and calculate the adjustment factors</span>
<span class="n">QDM_trained</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">adjustment</span><span class="o">.</span><span class="n">QuantileDeltaMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">tas_obs_noleap</span><span class="p">,</span>      <span class="c1"># observational data</span>
                                                         <span class="n">tas_hist_raw</span><span class="p">,</span> <span class="c1"># raw model historical data</span>
                                             <span class="c1"># number of quantiles to estimate (see documentation)</span>
                                                         <span class="n">nquantiles</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
             <span class="c1"># additive adjustment, for interval variable (see documentation &amp; Cannon et al. 2015)</span>
                                                         <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
<span class="c1"># separate adjustment applied to each month, to correct for bias in seasonal cycle (see documentation)</span>
                                                         <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;time.month&#39;</span> 
                                                        <span class="p">)</span>

<span class="c1"># apply the bias correction to the historical and SSP3-7.0 data</span>
<span class="n">tas_hist_qdm</span> <span class="o">=</span> <span class="n">QDM_trained</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">tas_hist_raw</span><span class="p">,</span> 
                    <span class="c1"># how to interpolate between the nquantiles discrete quantile estimates                                  </span>
                                 <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>

<span class="n">tas_ssp3_qdm</span> <span class="o">=</span> <span class="n">QDM_trained</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">tas_ssp3_raw</span><span class="p">,</span>                                 
                                  <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="validating-the-bias-corrected-data">
<h2>6.1.6 Validating the Bias-Corrected Data<a class="headerlink" href="#validating-the-bias-corrected-data" title="Permalink to this heading">#</a></h2>
<p>As a first check, let’s compare the daily climatologies and PDFs of the observed and adjusted historical simulation. The adjusted historical PDF should match the observed PDF essentially perfectly. Since the data are grouped by month when calculating the adjustment factors, the <em>monthly</em> climatologies should match perfectly, but there may be some small bias remaining in the daily climatology. We could have chosen to group by <code class="docutils literal notranslate"><span class="pre">time.dayofyear</span></code>, but with only 31 years in each dataset, there is probably too small of a sample size to robustly characterize the whole distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the daily climatologies for the QDM data</span>
<span class="n">tas_hist_qdm_dailyclim</span> <span class="o">=</span> <span class="n">tas_hist_qdm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_hist_qdm_dailyclim_stdev</span> <span class="o">=</span> <span class="n">tas_hist_qdm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="n">tas_ssp3_qdm_dailyclim</span> <span class="o">=</span> <span class="n">tas_ssp3_qdm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_ssp3_qdm_dailyclim_stdev</span> <span class="o">=</span> <span class="n">tas_ssp3_qdm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit KDE curves for QDM data</span>
<span class="n">kde_hist_qdm</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_hist_qdm</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">kde_ssp3_qdm</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_ssp3_qdm</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># also fit KDE for raw SSP3-7.0 data</span>
<span class="n">kde_ssp3_raw</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot daily climatologies</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># daily climatologies as 1D curves</span>
<span class="n">tas_dailyclim_obs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Station Obs&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">tas_hist_qdm_dailyclim</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 QDM Historical&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">)</span>
<span class="n">tas_ssp3_qdm_dailyclim</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 QDM SSP3-7.0&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">)</span>


<span class="c1"># 1 sigma shading</span>
<span class="c1"># obs</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_dailyclim_obs</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span>
                <span class="n">tas_dailyclim_obs</span> <span class="o">-</span> <span class="n">tas_dailyclim_std_obs</span><span class="p">,</span> 
                <span class="n">tas_dailyclim_obs</span> <span class="o">+</span> <span class="n">tas_dailyclim_std_obs</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="c1"># QDM historical</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_hist_qdm_dailyclim</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> 
                <span class="n">tas_hist_qdm_dailyclim</span> <span class="o">-</span> <span class="n">tas_hist_qdm_dailyclim_stdev</span><span class="p">,</span>
                <span class="n">tas_hist_qdm_dailyclim</span>  <span class="o">+</span> <span class="n">tas_hist_qdm_dailyclim_stdev</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">)</span>

<span class="c1"># QDM SSP3-7.0</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tas_ssp3_qdm_dailyclim</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">,</span> 
                <span class="n">tas_ssp3_qdm_dailyclim</span> <span class="o">-</span> <span class="n">tas_ssp3_qdm_dailyclim_stdev</span><span class="p">,</span>
                <span class="n">tas_ssp3_qdm_dailyclim</span>  <span class="o">+</span> <span class="n">tas_ssp3_qdm_dailyclim_stdev</span><span class="p">,</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">)</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Edmonton Daily Mean Temperature Daily Climatology&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Daily Mean Temperature (degC)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/36ccc175535c2efeb655a18f8372521285c83195b70993dfc3471afe42a84c75.png" src="../_images/36ccc175535c2efeb655a18f8372521285c83195b70993dfc3471afe42a84c75.png" />
</div>
</div>
<p>The daily climatology of the QDM historical data matches much more closely with the station observations than the raw model did. Most notably, the uncertainty shading shows greater overlap, indicating a better match of the interannual variability for each day of the year. Additionally, the timing of the peak temperatures in the summertime matches better than it did for the raw model.</p>
<p>The bias-adjusted future projections look largely similar to those from the raw model. There is still a very large warming signal in the peak summertime temperatures, though it does not stand out as far from the historical range as it did in the raw model. This is likely because the raw model has a positive bias in summertime temperatures, so the relative increase in the bias-adjusted data has a smaller magnitude.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot KDEs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Edmonton Daily Mean Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_obs</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Station Obs&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

<span class="c1"># historical</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_hist_raw</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CESM2 Raw Historical&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_hist_qdm</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CESM2 QDM Historical&#39;</span><span class="p">,</span>
         <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="c1"># SSP3-7.0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_ssp3_raw</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CESM2 Raw SSP3-7.0&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_ssp3_qdm</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CESM2 QDM SSP3-7.0&#39;</span><span class="p">,</span> 
         <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># KS test between QDM historical and obs</span>
<span class="n">pval_ks</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ks_2samp</span><span class="p">(</span><span class="n">tas_hist_qdm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">pvalue</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">37</span><span class="p">,</span> <span class="mf">0.027</span><span class="p">,</span> <span class="s2">&quot;KS Test p-value: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pval_ks</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/94386ce721a6ffefff8cfbaec7c4f26cffb8e8c285ce7bb611b2ae4d75db893b.png" src="../_images/94386ce721a6ffefff8cfbaec7c4f26cffb8e8c285ce7bb611b2ae4d75db893b.png" />
</div>
</div>
<p>Comparing the PDFs of the raw model and bias-corrected output, we can see the impact of applying QDM. The bias-adjusted historical simulation matches the observed PDF much more closely, though it still has a slightly higher low-temperature peak than the observations. This may be an artefact introduced by the monthly grouping - we enforced that the distributions for each month of the year must match individually, not the overall distribution. We can test if the bias-adjusted data follows a significantly different distribution than the observations using the <a class="reference external" href="https://en.wikipedia.org/wiki/Kolmogorov%E2%80%93Smirnov_test">Kolmogorov-Smirnov test</a>, like in Section 4.4.1. The null hypothesis of this test is that both samples being compared are drawn from the same underlying probability distribution. The p-value of 0.51 is sufficiently high that we fail to reject the null hypothesis, and thus there isn’t sufficient evidence to claim that they follow different sampling distributions.</p>
<p>The effect of the bias adjustment on the SSP3-7.0 projections is fairly minor, though it does weaken the low-temperature peak of the PDF, much like it does for the historical distribution. Whether this leads to any substantial change in the projections of CDDs is difficult to discern from looking at the PDF. All in all, the bias was fairly minimal for this model, so it’s no surprise that the effect of the bias adjustment is marginal.</p>
</div>
<div class="section" id="downscaled-projections-of-our-climate-indicator">
<h2>6.1.7 Downscaled Projections of our Climate Indicator<a class="headerlink" href="#downscaled-projections-of-our-climate-indicator" title="Permalink to this heading">#</a></h2>
<p>Next, we will investigate the effect of the bias adjustment on the calculation of CDDs, including both validating the downscaled historical data and assessing the changes to the downscaled future projections.</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate CDDs</span>
<span class="n">cdd_hist_qdm</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_hist_qdm</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_ssp3_qdm</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_ssp3_qdm</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term means</span>
<span class="n">cdd_hist_qdm_ltm</span> <span class="o">=</span> <span class="n">cdd_hist_qdm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_ssp3_qdm_ltm</span> <span class="o">=</span> <span class="n">cdd_ssp3_qdm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># stdevs</span>
<span class="n">cdd_hist_qdm_stdev</span> <span class="o">=</span> <span class="n">cdd_hist_qdm</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_ssp3_qdm_stdev</span> <span class="o">=</span> <span class="n">cdd_ssp3_qdm</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot timeseries of annual CDDs for the downscaled model data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">cdd_obs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Station Obs (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw Historical (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 Raw SSP3-7.0 (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_ssp3_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>

<span class="n">cdd_hist_qdm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 QDM Historical (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_hist_qdm_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                       <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
<span class="n">cdd_ssp3_qdm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CESM2 QDM SSP3-7.0 (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_ssp3_qdm_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                       <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>

<span class="c1"># plot long-term means</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_ssp3_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
          <span class="n">cdd_hist_qdm_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_ssp3_qdm_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> 
          <span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
          <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edmonton Cooling Degree Days&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;CDD&quot;</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># show the mean change on the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> 
        <span class="s2">&quot;Raw Mean Change: </span><span class="si">%.1f</span><span class="s2"> CDDs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdd_ssp3_raw_ltm</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> 
        <span class="s2">&quot;QDM Mean Change: </span><span class="si">%.1f</span><span class="s2"> CDDs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdd_ssp3_qdm_ltm</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">cdd_hist_qdm_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1e6193895699a83b12bd975c95c4ab047da9ef10838d710b34d56c24d5972b61.png" src="../_images/1e6193895699a83b12bd975c95c4ab047da9ef10838d710b34d56c24d5972b61.png" />
</div>
</div>
<p>The effect of the bias adjustment on the model historical CDDs is positive - the mean number of annual CDDs is very close to the observed long-term mean. The number of future CDDs also increases as a result of the bias correction, but the mean change is essentially unchanged. This behavior might lead you to question whether the bias correction was worth it at all, but remember that this model had a very low bias in daily mean temperature for our study site. Other models, which we’ll investigate in the next section, may not show the same behavior.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Chapter6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="chapter6.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Chapter 6: Workflow Examples</p>
      </div>
    </a>
    <a class="right-next"
       href="section6.2_station_1D_example_multimodel.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">6.2 Edmonton AC Loads: Multi-Model Analysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminary-study-design">6.1.1 Preliminary Study Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-and-downloading-the-datasets">6.1.2 Selecting and Downloading the Datasets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-model-obs-consistency">6.1.3 Assessing Model-Obs Consistency</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-climate-change-signal">6.1.4 Evaluating the Climate Change Signal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-the-bias-correction">6.1.5 Applying the Bias Correction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validating-the-bias-corrected-data">6.1.6 Validating the Bias-Corrected Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downscaled-projections-of-our-climate-indicator">6.1.7 Downscaled Projections of our Climate Indicator</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mike Morris, Karen Smith, and Paul Kushner
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>