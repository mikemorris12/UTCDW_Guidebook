

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6.6 Future Toronto Electricity Demands from Cooling &#8212; UTCDW Guidebook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Chapter6/section6.6_Toronto_Electricity_example';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="References" href="../guidebook_references.html" />
    <link rel="prev" title="6.5 Edmonton AC Loads: Gridded Example" href="section6.5_gridded_DBCCA_example.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    UTCDW Guidebook
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter1/chapter1.html">Chapter 1: Introduction</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/section1.1_python_env.html">1.1 Setting Up Your Python Environment</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter2/chapter2.html">Chapter 2: Intro to Climate Science and Modeling</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.1_climate_basics.html">2.1 Climate Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.2_climate_modeling.html">2.2 Climate Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.3_climate_model_uncertainty.html">2.3 Climate Model Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/chapter2_summary.html">2.4 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter3/chapter3.html">Chapter 3: Exploring Climate Data</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.1_station_data.html">3.1 Station Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.2_gridded_obs.html">3.2 Gridded Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.3_reanalysis.html">3.3 Reanalysis Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.4_climate_model_output.html">3.4 Climate Model Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/section3.5_model_data_on_google_cloud.html">3.5 Climate Model Data on Google Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/chapter3_summary.html">3.6 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter4/chapter4.html">Chapter 4: Statistical Downscaling</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.1_downscaling_basics.html">4.1 Downscaling Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.2_bias_correction_methods.html">4.2 Bias-Correction Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.3_downscaling_methods.html">4.3 Downscaling Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.4_downscaling_validation.html">4.4 Downscaling Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.5_assessing_downscaled_projections.html">4.5 Assessing Downscaled Climate Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/chapter4_summary.html">4.6 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter5/chapter5.html">Chapter 5: Downscaling Workflow</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.1_climate_indicators.html">5.1 Climate Indicators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.2_data_selection.html">5.2 Data Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.3_exploratory_data_analysis.html">5.3 Exploratory Data Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.4_producing_downscaled_data.html">5.4 Producing Downscaled Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/chapter5_summary.html">5.5 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="chapter6.html">Chapter 6: Workflow Examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="section6.1_station_1D_example_onesim.html">6.1 Edmonton AC Loads: Single Simulation Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.2_station_1D_example_multimodel.html">6.2 Edmonton AC Loads: Multi-Model Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.3_station_1D_example_multiscen.html">6.3 Edmonton AC Loads: Multi-Scenario Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.4_station_1D_example_nearterm.html">6.4 Edmonton AC Loads: Near-Term Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="section6.5_gridded_DBCCA_example.html">6.5 Edmonton AC Loads: Gridded Example</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">6.6 Future Toronto Electricity Demands from Cooling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../guidebook_references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Chapter6/section6.6_Toronto_Electricity_example.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>6.6 Future Toronto Electricity Demands from Cooling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survey-output">6.6.1 Survey Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#point-based-downscaling-quantile-delta-mapping">6.6.2 Point-Based Downscaling: Quantile-Delta Mapping</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-data">6.6.2.1 Downloading Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-station-data">6.6.2.2 Plotting Station Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-model-data">6.6.2.3 Plotting Model Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-climatologies-and-plotting-temperature-distribution">6.6.2.4 Calculating Climatologies and Plotting Temperature Distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-cooling-degree-days">6.6.2.5 Plotting Cooling Degree Days</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downscaling-with-a-spatial-dimension-dbcca">6.6.3 Downscaling with a Spatial Dimension: DBCCA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-different-model-results">6.6.4 Comparing Different Model Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-change-in-cdds-for-all-3-models">6.6.4.1 Comparing change in CDDs for all 3 models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-model-mean">6.6.4.2 Multi-Model Mean</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-indicator-choices">6.6.5 Exploring Indicator Choices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-indicator-historical-correlation">6.6.5.1 Custom Indicator: Historical Correlation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="future-toronto-electricity-demands-from-cooling">
<h1>6.6 Future Toronto Electricity Demands from Cooling<a class="headerlink" href="#future-toronto-electricity-demands-from-cooling" title="Permalink to this heading">#</a></h1>
<p>This is a worked example of the UTCDW workflow examining the impact of future extreme heat on energy demand in Toronto, Ontario. While less pedagogically focused than the previous worked examples, it shows how a user of the might implement the workflow in practice. This example was developed by Cassandra Chanen and edited by Michael Morris.</p>
<p>According to IESO, air-conditioning accounts for roughly one-third of Ontario’s electricity use on hot summer days. In 2019, Environment and Climate Change Canada released a report that found Canada is warming at rougly twice the global average rate [1]. Toronto is particularly important to study because it is an urban heat island, and because Toronto and its surrounding areas are heavily populated.
While understanding future energy demand is a complex question that could influenced by a wide range of variables, it is key that understanding future heat is a crucial component.</p>
<p>[1] (Bush, E. and Lemmen, D.S., editors (2019): Canada’s Changing Climate Report; Government of Canada, Ottawa, ON. 444 p.)</p>
<div class="section" id="survey-output">
<h2>6.6.1 Survey Output<a class="headerlink" href="#survey-output" title="Permalink to this heading">#</a></h2>
<p>In order to explore this question, we first filled out the UTCDW survey. This survey guides the user through key questions that need to be answered in order to proceed with the downscaling process.</p>
<p>Two historical time periods (1981-2000 and 2001-2020) and two future time periods (2031-2050 and 2081-2100) were selected. CanESM5 was chosen for the model data, and a combination of station data and NRCan gridded data was chosen for the observation data.</p>
<p>Cooling degree days was chosen as an engineering indicator because it is a commonly used to project energy consumption from cooling. Cooling degree days are calculated using the number of degrees above 18 degrees Celcius the average temperature is on a given day. For example, if the average temperature is 20 degrees on a given day that day has a CDD value of 2. If it is 20 degrees for an entire week, there are 14 CDDs that week.</p>
<p>Daily temperatures were chosen as the relevant climactic indicators required to calculate cooling degree days.</p>
<img src="Toronto_Electricity_Images/survey.png" alt="Survey"></div>
<div class="section" id="point-based-downscaling-quantile-delta-mapping">
<h2>6.6.2 Point-Based Downscaling: Quantile-Delta Mapping<a class="headerlink" href="#point-based-downscaling-quantile-delta-mapping" title="Permalink to this heading">#</a></h2>
<div class="section" id="downloading-data">
<h3>6.6.2.1 Downloading Data<a class="headerlink" href="#downloading-data" title="Permalink to this heading">#</a></h3>
<p><strong>Model Data</strong></p>
<p>The following code was used to download CanESM5 data for ssp245 and ssp434.</p>
<p><strong>NRCan Gridded Observations</strong></p>
<p>The following python code was used to download NRCan data for Southern Ontario from 1981-2020:</p>
<p><strong>Station Data</strong></p>
<p>The following python code was used to download station data for Southern Ontario from 1981-2020:</p>
</div>
<div class="section" id="plotting-station-data">
<h3>6.6.2.2 Plotting Station Data<a class="headerlink" href="#plotting-station-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">import</span> <span class="nn">nc_time_axis</span>

<span class="n">spkws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">from</span> <span class="nn">siphon.catalog</span> <span class="kn">import</span> <span class="n">TDSCatalog</span>
<span class="kn">from</span> <span class="nn">xclim.core.calendar</span> <span class="kn">import</span> <span class="n">convert_calendar</span><span class="p">,</span> <span class="n">percentile_doy</span>
<span class="kn">import</span> <span class="nn">xclim.indices</span> <span class="k">as</span> <span class="nn">xci</span>

<span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">avg_lat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">avg_lon</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5085</span><span class="p">,</span> <span class="mi">30247</span><span class="p">,</span> <span class="mi">48549</span><span class="p">]:</span> 
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/home/cchanen/UTCDW/data/station/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-daily-1981-2020.csv&#39;</span><span class="p">)</span>
    <span class="c1">#print(df.head())</span>

    <span class="n">column_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date/Time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;Max Temp (°C)&#39;</span><span class="p">:</span> <span class="s1">&#39;MaxTemp&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;Min Temp (°C)&#39;</span><span class="p">:</span> <span class="s1">&#39;MinTemp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mean Temp (°C)&#39;</span><span class="p">:</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Total Precip (mm)&#39;</span><span class="p">:</span> <span class="s1">&#39;TotalPrecip&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Latitude (y)&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Longitude (x)&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Station Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">}</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">column_name_dict</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">column_name_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    
    <span class="n">avg_lat</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">])</span>
    <span class="n">avg_lon</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">])</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tas&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">df3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Toronto City Centre (</span><span class="si">%2.2f</span><span class="s1">, </span><span class="si">%2.2f</span><span class="s1">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">avg_lat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">avg_lon</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Temperature&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0082f85b3fcac151deca181e99e7b416ff17147e210f1a65ce20469d4f21d5af.png" src="../_images/0082f85b3fcac151deca181e99e7b416ff17147e210f1a65ce20469d4f21d5af.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># merge the data from different station IDs into a single dataframe</span>
<span class="n">df_tor_int</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span> <span class="n">df2</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">stn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_tor_int</span> <span class="p">,</span> <span class="n">df3</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># now convert it to xarray format for easier use with the model data and xclim</span>
<span class="c1"># drop lat and lon variables, since we want these to be coordinates in the xr.Dataset</span>
<span class="n">stn_lon</span> <span class="o">=</span> <span class="n">stn_df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span> <span class="c1"># convert lon to same convention as model data</span>
<span class="n">stn_lat</span> <span class="o">=</span> <span class="n">stn_df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">stn_df</span> <span class="o">=</span> <span class="n">stn_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">stn_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">stn_df</span><span class="p">)</span>
<span class="n">stn_ds</span> <span class="o">=</span> <span class="n">stn_ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="n">stn_lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">stn_lon</span><span class="p">)</span>
<span class="n">stn_ds</span>
<span class="n">stn_ds_1981_2000</span> <span class="o">=</span> <span class="n">stn_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1981-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-12-31&#39;</span><span class="p">))</span>
<span class="n">stn_ds_2001_2020</span> <span class="o">=</span> <span class="n">stn_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;2001-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plotting-model-data">
<h3>6.6.2.3 Plotting Model Data<a class="headerlink" href="#plotting-model-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first open the CanESM5 data, all files at once - open_mfdataset will automatically concatenate them in time</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;/data/kushner_group/CMIP6/CanESM5/historical/atmos/tas/day&#39;</span>
<span class="n">ds_CanESM5</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">([</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s2">&quot;/tas_day_CanESM5_historical_r15i1p2f1_gn_18500101-20141231.nc&quot;</span><span class="p">,</span> <span class="n">data_directory</span> <span class="o">+</span> <span class="s2">&quot;/tas_day_CanESM5_ssp585_r15i1p2f1_gn_20150101-21001231.nc&quot;</span><span class="p">])</span>
<span class="n">tas_CanESM5_full</span> <span class="o">=</span> <span class="n">ds_CanESM5</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">avg_lat</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">avg_lon</span><span class="p">)</span> <span class="o">+</span> <span class="mi">360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span>
<span class="n">tas_CanESM5</span> <span class="o">=</span> <span class="n">tas_CanESM5_full</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1981-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">))</span>
<span class="n">tas_CanESM5_1981_2000</span> <span class="o">=</span> <span class="n">tas_CanESM5_full</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1981-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-12-31&#39;</span><span class="p">))</span>
<span class="n">tas_CanESM5_2001_2020</span> <span class="o">=</span> <span class="n">tas_CanESM5_full</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;2001-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">))</span>

<span class="n">tas_CanESM5_2031_2050</span> <span class="o">=</span> <span class="n">tas_CanESM5_full</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;2031-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2050-12-31&#39;</span><span class="p">))</span>
<span class="n">tas_CanESM5_2081_2100</span> <span class="o">=</span> <span class="n">tas_CanESM5_full</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;2081-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2100-12-31&#39;</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tas_CanESM5_full</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">47815</span><span class="p">:</span><span class="mi">62414</span><span class="p">],</span> <span class="n">tas_CanESM5_full</span><span class="p">[</span><span class="mi">47815</span><span class="p">:</span><span class="mi">62414</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CanESM5 r15i1p2f1&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Daily Mean Temperature in Toronto&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3698696a5866627255baa9531f9bd592f4b2a0cf21d07a064918cdcdd74751ba.png" src="../_images/3698696a5866627255baa9531f9bd592f4b2a0cf21d07a064918cdcdd74751ba.png" />
</div>
</div>
</div>
<div class="section" id="calculating-climatologies-and-plotting-temperature-distribution">
<h3>6.6.2.4 Calculating Climatologies and Plotting Temperature Distribution<a class="headerlink" href="#calculating-climatologies-and-plotting-temperature-distribution" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate station daily climatology again after converting its calendar to match the model</span>
<span class="n">stn_ds_noleap</span> <span class="o">=</span> <span class="n">convert_calendar</span><span class="p">(</span><span class="n">stn_ds</span><span class="p">,</span> <span class="s1">&#39;noleap&#39;</span><span class="p">)</span>
<span class="n">tas_obs_noleap</span> <span class="o">=</span> <span class="n">stn_ds_noleap</span><span class="o">.</span><span class="n">tas</span>

<span class="n">tas_dailyclim_obs</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_dailyclim_std_obs</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="n">tas_dailyclim_CanESM5</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_dailyclim_std_CanESM5</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit Kernel Density Estimator so we can plot a smooth distribution</span>
<span class="n">kde_hist_raw</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">kde_obs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> 

<span class="c1"># means and stdev ratios</span>
<span class="n">tas_hist_raw_mean</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_obs_mean</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># stdevs for each dataset</span>
<span class="n">tas_hist_raw_stdev</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">tas_obs_stdev</span> <span class="o">=</span> <span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the PDFs smoothed by KDE</span>
<span class="n">temperatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Toronto Daily Mean Temperature 1981-2020&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_obs</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Station Obs&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_hist_raw</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CanESM5 Historical&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">([</span><span class="n">tas_hist_raw_mean</span><span class="p">,</span> <span class="n">tas_obs_mean</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># annotate with mean bias and ratio of stdevs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mf">0.038</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Mean Bias: </span><span class="si">%.2f</span><span class="s1"> $^{\circ}$C&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tas_hist_raw_mean</span> <span class="o">-</span> <span class="n">tas_obs_mean</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Stdev Ratio: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tas_hist_raw_stdev</span> <span class="o">/</span> <span class="n">tas_obs_stdev</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/31460028d263a6f083799e7695c317ed28de4ea02e0221f6d4ff204677c03573.png" src="../_images/31460028d263a6f083799e7695c317ed28de4ea02e0221f6d4ff204677c03573.png" />
</div>
</div>
</div>
<div class="section" id="plotting-cooling-degree-days">
<h3>6.6.2.5 Plotting Cooling Degree Days<a class="headerlink" href="#plotting-cooling-degree-days" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add unit attributes to tas data for use with xclim routines</span>
<span class="n">tas_obs_noleap</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>
<span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs</span>
<span class="n">cdd_obs</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_obs_noleap</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_hist_raw</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_CanESM5</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term means for the historical period</span>
<span class="n">cdd_obs_ltm</span> <span class="o">=</span> <span class="n">cdd_obs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_hist_raw_ltm</span> <span class="o">=</span> <span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot timeseries of CDDs for model historical and obs</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">cdd_obs</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Station Obs (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
<span class="n">cdd_hist_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CanESM5 Raw Historical (</span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>

<span class="c1"># plot long-term means</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> 
          <span class="n">cdd_obs</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cdd_obs</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
          <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Toronto Cooling Degree Days 1981-2020&quot;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;CDD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># show the mean bias on the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cdd_obs</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="s2">&quot;Mean Bias: </span><span class="si">%.1f</span><span class="s2"> CDDs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">cdd_obs_ltm</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/391871c37d2b9f9f0168641d48ab77f9d5428c85bc0f4e83a3406d6bad5394a6.png" src="../_images/391871c37d2b9f9f0168641d48ab77f9d5428c85bc0f4e83a3406d6bad5394a6.png" />
</div>
</div>
<p>The results of this plot demonstrate that even a relatively small mean temperature bias (-0.01) can translate to a significant mean CDD bias (231.7).</p>
</div>
</div>
<div class="section" id="downscaling-with-a-spatial-dimension-dbcca">
<h2>6.6.3 Downscaling with a Spatial Dimension: DBCCA<a class="headerlink" href="#downscaling-with-a-spatial-dimension-dbcca" title="Permalink to this heading">#</a></h2>
<p>This section adds a spatial dimension to the downscaling problem approached in the previous section (Cooling Degree Days in Southern Ontario). The downscaling technique used is Double Bias Correction Constructed Analogs (DBCCA).</p>
<p>DBCCA code can be downloaded from the UTCDW Github.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add the downscaling_code directory to the PATH so the functions can be imported. </span>
<span class="c1"># you will need to change the argument passed to sys.path.append() to be wherever you</span>
<span class="c1"># saved the scripts when you cloned the repository or downloaded the scripts individually.</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/home/mmorris/UTCDW_Guidebook/downscaling_code&quot;</span><span class="p">)</span>

<span class="c1"># now import the DBCCA function</span>
<span class="kn">from</span> <span class="nn">DBCCA</span> <span class="kn">import</span> <span class="n">DBCCA</span>

<span class="c1"># import other the necessary packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">from</span> <span class="nn">siphon.catalog</span> <span class="kn">import</span> <span class="n">TDSCatalog</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">ec3</span>
<span class="kn">import</span> <span class="nn">xclim.indices</span> <span class="k">as</span> <span class="nn">xci</span>
<span class="kn">from</span> <span class="nn">xclim.core.calendar</span> <span class="kn">import</span> <span class="n">convert_calendar</span>
<span class="kn">import</span> <span class="nn">gcsfs</span>
<span class="kn">import</span> <span class="nn">zarr</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">spkws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

<span class="c1"># spatial boundaries of our study region - a 5x5 degree region around Toronto</span>
<span class="n">lat_bnds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">43.63</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">43.63</span><span class="o">+</span><span class="mf">2.5</span><span class="p">]</span>
<span class="n">lon_bnds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">79.4</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">79.4</span><span class="o">+</span><span class="mf">2.5</span><span class="p">]</span>
<span class="n">lon_bnds360</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="o">+</span> <span class="mi">360</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lon_bnds</span><span class="p">]</span>

<span class="c1"># lat and lon coordinates for Toronto</span>
<span class="n">lat_tor</span> <span class="o">=</span> <span class="mf">43.63</span>
<span class="n">lon_tor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">79.4</span>

<span class="c1"># time periods for historical and future periods</span>
<span class="n">years_hist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1981</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">years_future</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2071</span><span class="p">,</span> <span class="mi">2100</span><span class="p">)</span>

<span class="c1"># url for the CSV file that contains the CMIP model data catalog</span>
<span class="n">url_gcsfs_catalog</span> <span class="o">=</span> <span class="s1">&#39;https://storage.googleapis.com/cmip6/cmip6-zarr-consolidated-stores.csv&#39;</span>

<span class="c1"># PAVICS URL for ERA5 data</span>
<span class="n">url_pavics_era5</span> <span class="o">=</span> <span class="s2">&quot;https://pavics.ouranos.ca/twitcher/ows/proxy/thredds/catalog/datasets/reanalyses/catalog.xml&quot;</span>

<span class="c1"># access the ERA5-LAND data through the OPenDAP server</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">TDSCatalog</span><span class="p">(</span><span class="n">url_pavics_era5</span><span class="p">)</span>
<span class="n">ix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;day_ERA5-Land_NAM.ncml&quot;</span><span class="p">)</span>
<span class="n">era5_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">access_urls</span><span class="p">[</span><span class="s2">&quot;OPENDAP&quot;</span><span class="p">])</span>

<span class="c1"># subset spatially and temporally</span>
<span class="n">tas_obs</span> <span class="o">=</span> <span class="n">era5_ds</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds</span><span class="p">),</span> 
                          <span class="n">time</span> <span class="o">=</span> <span class="n">era5_ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_hist</span><span class="p">))</span>
<span class="c1"># convert units</span>
<span class="n">tas_obs</span> <span class="o">=</span> <span class="n">tas_obs</span> <span class="o">-</span> <span class="mf">273.15</span>

<span class="c1"># convert calendar to noleap</span>
<span class="n">tas_obs</span> <span class="o">=</span> <span class="n">convert_calendar</span><span class="p">(</span><span class="n">tas_obs</span><span class="p">,</span> <span class="s1">&#39;noleap&#39;</span><span class="p">)</span>

<span class="c1"># first open the NRCan data, all files at once - open_mfdataset will automatically concatenate them in time</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;/home/cchanen/UTCDW/nrcan_data&#39;</span>
<span class="n">nrcan_1981_tmin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">([</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s2">&quot;/tasmin_NRCAN_sontario.1981-2000.nc&quot;</span><span class="p">])</span>
<span class="n">nrcan_1981_tmax</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">([</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s2">&quot;/tasmax_NRCAN_sontario.1981-2000.nc&quot;</span><span class="p">])</span>

<span class="n">nrcan_tas</span> <span class="o">=</span> <span class="n">nrcan_1981_tmin</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tavg</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">nrcan_1981_tmin</span><span class="p">[</span><span class="s2">&quot;tasmin&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">nrcan_1981_tmax</span><span class="p">[</span><span class="s2">&quot;tasmax&quot;</span><span class="p">])</span>
<span class="n">nrcan_tas_2</span> <span class="o">=</span> <span class="n">nrcan_tas</span><span class="p">[</span><span class="s1">&#39;tavg&#39;</span><span class="p">]</span>
<span class="n">nrcan_min_dailyclim_1981</span> <span class="o">=</span> <span class="n">nrcan_1981_tmin</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">nrcan_max_dailyclim_1981</span> <span class="o">=</span> <span class="n">nrcan_1981_tmax</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">nrcan_dailyclim_1981</span> <span class="o">=</span> <span class="n">nrcan_min_dailyclim_1981</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nrcan_dailyclim_1981</span><span class="p">)</span>
<span class="n">nrcan_dailyclim_1981_2</span> <span class="o">=</span> <span class="n">nrcan_dailyclim_1981</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tavg</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">nrcan_min_dailyclim_1981</span><span class="p">[</span><span class="s2">&quot;tasmin&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">nrcan_max_dailyclim_1981</span><span class="p">[</span><span class="s2">&quot;tasmax&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">)</span>
<span class="n">nrcan_dailyclim_1981_2</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;tasmin&#39;</span><span class="p">)</span>

<span class="n">nrcan_tas_obs</span> <span class="o">=</span> <span class="n">nrcan_dailyclim_1981_2</span><span class="o">.</span><span class="n">tavg</span>

<span class="c1"># download the CESM2 model data from Google Cloud - this code is mostly the same as 6.1</span>

<span class="c1"># open the Google Cloud model data catalog with pandas</span>
<span class="n">df_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url_gcsfs_catalog</span><span class="p">)</span>

<span class="c1"># search for our selected model, both historical and SSP3-7.0 scenarios</span>
<span class="n">search_string</span> <span class="o">=</span> <span class="s2">&quot;table_id == &#39;day&#39; &amp; source_id == &#39;CESM2&#39; &amp; variable_id == &#39;tas&#39;&quot;</span> <span class="c1"># continue on the next line</span>
<span class="n">search_string</span> <span class="o">+=</span> <span class="s2">&quot; &amp; experiment_id == [&#39;historical&#39;, &#39;ssp370&#39;]&quot;</span>
<span class="n">df_search</span> <span class="o">=</span> <span class="n">df_catalog</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">search_string</span><span class="p">)</span>

<span class="c1"># filter the search results further for the ensemble member we want to use</span>
<span class="n">df_search_r10i1p1f1</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;member_id == &#39;r10i1p1f1&#39;&quot;</span><span class="p">)</span>

<span class="c1"># authenticate access to Google Cloud</span>
<span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="s1">&#39;anon&#39;</span><span class="p">)</span>

<span class="c1"># get the URLs for each dataset and turn into zarr store mappers</span>
<span class="n">url_hist</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;historical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_hist</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_hist</span><span class="p">)</span>
<span class="n">url_ssp3</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;ssp370&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_ssp3</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_ssp3</span><span class="p">)</span>

<span class="c1"># download the datasets, subset, and convert units</span>
<span class="c1"># historical</span>
<span class="n">ds_hist_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_hist</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_hist_raw</span> <span class="o">=</span> <span class="n">ds_hist_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># also convert to C</span>

<span class="c1"># future</span>
<span class="n">ds_ssp3_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_ssp3</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_ssp3_raw</span> <span class="o">=</span> <span class="n">ds_ssp3_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.Dataset&gt;
Dimensions:  (lat: 108, lon: 48, month: 12)
Coordinates:
  * lat      (lat) float32 49.96 49.88 49.79 49.71 ... 41.29 41.21 41.12 41.04
  * lon      (lon) float32 -81.96 -81.88 -81.79 -81.71 ... -78.21 -78.12 -78.04
  * month    (month) int64 1 2 3 4 5 6 7 8 9 10 11 12
Data variables:
    tasmin   (month, lat, lon) float32 247.9 247.8 247.7 247.6 ... nan nan nan
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select time periods</span>
<span class="n">tas_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_hist</span><span class="p">))</span>
<span class="n">tas_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_future</span><span class="p">))</span>

<span class="c1"># calculate the raw model historical monthly climatology</span>
<span class="n">tas_hist_raw_monthlyclim</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># same for observations</span>
<span class="n">tas_obs_monthlyclim</span> <span class="o">=</span> <span class="n">tas_obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># plot model monthly clim</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;CESM2 1981-2000 Historical tas Monthly Climatology&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tas_hist_raw_monthlyclim</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                  <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                  <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                                                                  <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># label where Toronto is on the map</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="c1"># add legend only to one panel</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.075</span><span class="p">))</span> 
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Daily Mean Temp. ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/edf98a1932614d75599a87e62cbec8e418db3d9dc4b11bfa1ca0af9e73f0137d.png" src="../_images/edf98a1932614d75599a87e62cbec8e418db3d9dc4b11bfa1ca0af9e73f0137d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_lat</span> <span class="o">=</span> <span class="mf">43.63</span><span class="o">-</span><span class="mi">2</span>
<span class="n">min_lat</span> <span class="o">=</span> <span class="mf">43.63</span><span class="o">+</span><span class="mi">2</span>

<span class="n">nrcan_tas_obs_cropped</span> <span class="o">=</span> <span class="n">nrcan_tas_obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lat</span><span class="p">,</span><span class="n">max_lat</span><span class="p">))</span>

<span class="c1"># plot obs monthly clim</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;NRCan 1981-2000 tas Monthly Climatology&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">nrcan_tas_obs_cropped</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                  <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                  <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                                                                  <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Daily Mean Temp. ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a6b2e2e2438e216428fcdf2ef6053bc4d11b5a1a85712a02000bc5481c8316f9.png" src="../_images/a6b2e2e2438e216428fcdf2ef6053bc4d11b5a1a85712a02000bc5481c8316f9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add unit attribute required by xclim</span>
<span class="n">tas_obs</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>
<span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>
<span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs for each dataset</span>
<span class="n">cdds_obs</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_obs</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdds_hist_raw</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_hist_raw</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdds_ssp3_raw</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_ssp3_raw</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term annual means</span>
<span class="n">cdds_obs_ltm</span> <span class="o">=</span> <span class="n">cdds_obs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_hist_raw_ltm</span> <span class="o">=</span> <span class="n">cdds_hist_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">cdd_ssp3_raw_ltm</span> <span class="o">=</span> <span class="n">cdds_ssp3_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># plot maps of long-term mean CDDs for raw historical and obs</span>
<span class="n">levels_cdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;1980-2010 Mean Annual CDDs&quot;</span><span class="p">)</span>
<span class="n">p0</span> <span class="o">=</span> <span class="n">cdds_obs_ltm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ERA5-Land&quot;</span><span class="p">)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">cdd_hist_raw_ltm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CESM2 Raw Historical&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CDDs&quot;</span><span class="p">,</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">extendrect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/21a3a8df145da699689d40d4cea0928dca475c140714167e0ab90c32f96446ae.png" src="../_images/21a3a8df145da699689d40d4cea0928dca475c140714167e0ab90c32f96446ae.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot maps of changes long-term mean CDDs for raw CanESM5</span>
<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">cdd_delta_raw</span> <span class="o">=</span> <span class="n">cdd_ssp3_raw_ltm</span> <span class="o">-</span> <span class="n">cdd_hist_raw_ltm</span>

<span class="n">cdd_delta_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">cbar_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CDD Change&#39;</span><span class="p">),</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw CESM2 Change in Mean Annual CDDs </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/26010035f6a3708ec5838269c368cddd4a76c33c96609f132ac9efeff9daefe3.png" src="../_images/26010035f6a3708ec5838269c368cddd4a76c33c96609f132ac9efeff9daefe3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># de-chunk along the time dimension, required by xclim bias correction routines</span>
<span class="n">tas_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_obs</span> <span class="o">=</span> <span class="n">tas_obs</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="c1"># file names for intermediate BCCA files - saving these will help the code run faster later on if all</span>
<span class="c1"># you want to do is the last QDM step</span>

<span class="n">file_hist_bcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.CESM2.toronto.historical.r10i1p1f1.1980-2010.BCCA.nc&quot;</span>
<span class="n">file_ssp3_bcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.CESM2.toronto.ssp370.r10i1p1f1.2070-2100.BCCA.nc&quot;</span>

<span class="c1"># file paths for DBCCA output - it&#39;s good to save this because the code can take a long time to run</span>
<span class="n">file_hist_dbcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.CESM2.toronto.historical.r10i1p1f1.1980-2010.DBCCA.nc&quot;</span>
<span class="n">file_ssp3_dbcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.CESM2.toronto.ssp370.r10i1p1f1.2070-2100.DBCCA.nc&quot;</span>

<span class="c1"># open pre-computed DBCCA data if it exists</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_hist_dbcca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_ssp3_dbcca</span><span class="p">):</span>
    <span class="n">ds_hist_dbcca</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_hist_dbcca</span><span class="p">)</span>
    <span class="n">tas_hist_dbcca</span> <span class="o">=</span> <span class="n">ds_hist_dbcca</span><span class="o">.</span><span class="n">tas</span>
    <span class="n">ds_ssp3_dbcca</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_ssp3_dbcca</span><span class="p">)</span>
    <span class="n">tas_ssp3_dbcca</span> <span class="o">=</span> <span class="n">ds_ssp3_dbcca</span><span class="o">.</span><span class="n">tas</span> 
<span class="k">else</span><span class="p">:</span> <span class="c1"># do the downscaling - this will only run if the input files don&#39;t already exist</span>
    <span class="n">tas_hist_dbcca</span><span class="p">,</span> <span class="n">tas_ssp3_dbcca</span> <span class="o">=</span> <span class="n">DBCCA</span><span class="p">(</span><span class="n">tas_hist_raw</span><span class="p">,</span>
                                           <span class="n">tas_ssp3_raw</span><span class="p">,</span>
                                           <span class="n">tas_obs</span><span class="p">,</span>
                                           <span class="s2">&quot;tas&quot;</span><span class="p">,</span> 
                                           <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degC&quot;</span><span class="p">,</span>
                                           <span class="n">fout_hist_bcca</span> <span class="o">=</span> <span class="n">file_hist_bcca</span><span class="p">,</span>
                                           <span class="n">fout_future_bcca</span> <span class="o">=</span> <span class="n">file_ssp3_bcca</span><span class="p">,</span>
                                           <span class="n">fout_hist_dbcca</span> <span class="o">=</span> <span class="n">file_hist_dbcca</span><span class="p">,</span>
                                           <span class="n">fout_future_dbcca</span> <span class="o">=</span> <span class="n">file_ssp3_dbcca</span><span class="p">,</span>
                                           <span class="n">write_output</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
<span class="c1"># calculate the downscaled model historical monthly climatology</span>
<span class="n">tas_hist_dbcca_monthlyclim</span> <span class="o">=</span> <span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># difference between downscaled and ERA5-Land</span>
<span class="n">bias_clim_dbcca</span> <span class="o">=</span> <span class="n">tas_hist_dbcca_monthlyclim</span> <span class="o">-</span> <span class="n">tas_obs_monthlyclim</span>

<span class="c1"># plot model monthly clim</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;DBCCA CESM2 1980-2010 tas Monthly Climatology&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tas_hist_dbcca_monthlyclim</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                    <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                                                                    <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Daily Mean Temp. ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9c1c3f3e04613273b9dbc69c29841ac6b8c0c08ce71e4ee6e1f09b19d645c49b.png" src="../_images/9c1c3f3e04613273b9dbc69c29841ac6b8c0c08ce71e4ee6e1f09b19d645c49b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot model monthly clim bias</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;DBCCA CESM2 1980-2010 tas Monthly Climatology</span><span class="se">\n</span><span class="s2">Bias Relative to ERA5-Land&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">bias_clim_dbcca</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                    <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
                                                                    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                                                                    <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Daily Mean Temp. ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/612b9825b01658302f0b3116f1cf0318c8be32e2310155bb49364baa67a4d090.png" src="../_images/612b9825b01658302f0b3116f1cf0318c8be32e2310155bb49364baa67a4d090.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add units to downscaled data</span>
<span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs using the historical DBCCA data</span>
<span class="n">cdds_hist_dbcca</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_hist_dbcca</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term mean</span>
<span class="n">cdds_hist_dbcca_ltm</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># bias of the downscaled data</span>
<span class="n">cdds_hist_dbcca_ltm_bias</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca_ltm</span> <span class="o">-</span> <span class="n">cdds_obs_ltm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compare DBCCA historical CDDs to ERA5-Land CDDs</span>
<span class="n">levels_cdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;1980-2010 Mean Annual CDDs&quot;</span><span class="p">)</span>

<span class="c1"># obs</span>
<span class="n">p0</span> <span class="o">=</span> <span class="n">cdds_obs_ltm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ERA5-Land&quot;</span><span class="p">)</span>

<span class="c1"># downscaled model</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca_ltm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CESM2 DBCCA Historical&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CDDs&quot;</span><span class="p">,</span> 
             <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">extendrect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">aspect</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1"># bias</span>
<span class="n">levels_cdd_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca_ltm_bias</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                                              <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_bias</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;CDD Bias&quot;</span><span class="p">,</span> 
             <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">extendrect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">aspect</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Downscaled CanESM5 CDD Bias&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ccbee85e0ea4f316375a6d5e7d9c68e09e4baa884f7f8f8de942b0774fc9deb2.png" src="../_images/ccbee85e0ea4f316375a6d5e7d9c68e09e4baa884f7f8f8de942b0774fc9deb2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add units to downscaled future data</span>
<span class="n">tas_ssp3_dbcca</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs using the SSP3-7.0 DBCCA data</span>
<span class="n">cdds_ssp3_dbcca</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_ssp3_dbcca</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term mean</span>
<span class="n">cdds_ssp3_dbcca_ltm</span> <span class="o">=</span> <span class="n">cdds_ssp3_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># climate change delta</span>
<span class="n">cdds_delta_dbcca</span> <span class="o">=</span> <span class="n">cdds_ssp3_dbcca_ltm</span> <span class="o">-</span> <span class="n">cdds_hist_dbcca_ltm</span>

<span class="c1"># plot maps of changes long-term mean CDDs for raw and downscaled CESM2</span>
<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mf">37.5</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;CESM2 Change in Mean Annual CDDs </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010&quot;</span><span class="p">)</span>

<span class="c1"># downscaled model</span>
<span class="n">cdds_delta_dbcca</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;DBCCA&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">cdd_delta_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CDD Change&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a7197408508e84dc404d87cd4bb7e066f88bf4659e0aa6642218be6d7e0ce50a.png" src="../_images/a7197408508e84dc404d87cd4bb7e066f88bf4659e0aa6642218be6d7e0ce50a.png" />
</div>
</div>
</div>
<div class="section" id="comparing-different-model-results">
<h2>6.6.4 Comparing Different Model Results<a class="headerlink" href="#comparing-different-model-results" title="Permalink to this heading">#</a></h2>
<p>During the initial phase of this project, we made the decision to use the CESM2 model and an SSP3-7.0 scenario. In this section, we continue to explore and SSP3-7.0 scenario but use different models including CanESM5, and MPI.</p>
<p>Exploring different models is important because different models may be able to resolve certain aspects of future climate better than others. Using more models ensures that you are able to draw more robust conclusions about future climate and understand by looking at features are shared across models.</p>
<p><strong>CCCma CanESM5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># downloading model data from google cloud</span>

<span class="c1"># open the Google Cloud model data catalog with pandas</span>
<span class="n">df_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url_gcsfs_catalog</span><span class="p">)</span>

<span class="c1"># search for our selected model, both historical and SSP3-7.0 scenarios</span>
<span class="n">search_string</span> <span class="o">=</span> <span class="s2">&quot;table_id == &#39;day&#39; &amp; source_id == &#39;CanESM5&#39; &amp; variable_id == &#39;tas&#39;&quot;</span> <span class="c1"># continue on the next line</span>
<span class="n">search_string</span> <span class="o">+=</span> <span class="s2">&quot; &amp; experiment_id == [&#39;historical&#39;, &#39;ssp370&#39;]&quot;</span>
<span class="n">df_search</span> <span class="o">=</span> <span class="n">df_catalog</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">search_string</span><span class="p">)</span>

<span class="c1"># filter the search results further for the ensemble member we want to use</span>
<span class="n">df_search_r10i1p1f1</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;member_id == &#39;r10i1p1f1&#39;&quot;</span><span class="p">)</span>

<span class="c1"># authenticate access to Google Cloud</span>
<span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="s1">&#39;anon&#39;</span><span class="p">)</span>

<span class="c1"># get the URLs for each dataset and turn into zarr store mappers</span>
<span class="n">url_hist</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;historical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_hist</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_hist</span><span class="p">)</span>
<span class="n">url_ssp3</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;ssp370&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_ssp3</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_ssp3</span><span class="p">)</span>

<span class="c1"># download the datasets, subset, and convert units</span>
<span class="c1"># historical</span>
<span class="n">ds_hist_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_hist</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_hist_raw_canesm</span> <span class="o">=</span> <span class="n">ds_hist_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># also convert to C</span>

<span class="c1"># future</span>
<span class="n">ds_ssp3_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_ssp3</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_ssp3_raw_canesm</span> <span class="o">=</span> <span class="n">ds_ssp3_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span> 

<span class="c1"># select time periods</span>
<span class="n">tas_hist_raw_canesm</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_hist</span><span class="p">))</span>
<span class="n">tas_ssp3_raw_canesm</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_future</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># de-chunk along the time dimension, required by xclim bias correction routines</span>
<span class="n">tas_hist_raw_canesm</span> <span class="o">=</span> <span class="n">tas_hist_raw_canesm</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_ssp3_raw_canesm</span> <span class="o">=</span> <span class="n">tas_ssp3_raw_canesm</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_obs</span> <span class="o">=</span> <span class="n">tas_obs</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="c1"># file names for intermediate BCCA files - saving these will help the code run faster later on if all</span>
<span class="c1"># you want to do is the last QDM step</span>

<span class="n">file_hist_canesm_bcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.canesm.toronto.historical.r10i1p1f1.1980-2010.BCCA.nc&quot;</span>
<span class="n">file_ssp3_canesm_bcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.canesm.toronto.ssp370.r10i1p1f1.2070-2100.BCCA.nc&quot;</span>

<span class="c1"># file paths for DBCCA output - it&#39;s good to save this because the code can take a long time to run</span>
<span class="n">file_hist_canesm_dbcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.canesm.toronto.historical.r10i1p1f1.1980-2010.DBCCA.nc&quot;</span>
<span class="n">file_ssp3_canesm_dbcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.canesm.toronto.ssp370.r10i1p1f1.2070-2100.DBCCA.nc&quot;</span>

<span class="c1"># open pre-computed DBCCA data if it exists</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_hist_canesm_dbcca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_ssp3_canesm_dbcca</span><span class="p">):</span>
    <span class="n">ds_hist_dbcca</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_hist_canesm_dbcca</span><span class="p">)</span>
    <span class="n">tas_hist_dbcca</span> <span class="o">=</span> <span class="n">ds_hist_dbcca</span><span class="o">.</span><span class="n">tas</span>
    <span class="n">ds_ssp3_dbcca</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_ssp3_canesm_dbcca</span><span class="p">)</span>
    <span class="n">tas_ssp3_dbcca</span> <span class="o">=</span> <span class="n">ds_ssp3_dbcca</span><span class="o">.</span><span class="n">tas</span> 
<span class="k">else</span><span class="p">:</span> <span class="c1"># do the downscaling - this will only run if the input files don&#39;t already exist</span>
    <span class="n">tas_hist_dbcca</span><span class="p">,</span> <span class="n">tas_ssp3_dbcca</span> <span class="o">=</span> <span class="n">DBCCA</span><span class="p">(</span><span class="n">tas_hist_raw_canesm</span><span class="p">,</span>
                                           <span class="n">tas_ssp3_raw_canesm</span><span class="p">,</span>
                                           <span class="n">tas_obs</span><span class="p">,</span>
                                           <span class="s2">&quot;tas&quot;</span><span class="p">,</span> 
                                           <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degC&quot;</span><span class="p">,</span>
                                           <span class="n">fout_hist_bcca</span> <span class="o">=</span> <span class="n">file_hist_canesm_bcca</span><span class="p">,</span>
                                           <span class="n">fout_future_bcca</span> <span class="o">=</span> <span class="n">file_ssp3_canesm_bcca</span><span class="p">,</span>
                                           <span class="n">fout_hist_dbcca</span> <span class="o">=</span> <span class="n">file_hist_canesm_dbcca</span><span class="p">,</span>
                                           <span class="n">fout_future_dbcca</span> <span class="o">=</span> <span class="n">file_ssp3_canesm_dbcca</span><span class="p">,</span>
                                           <span class="n">write_output</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
<span class="c1"># calculate the downscaled model historical monthly climatology</span>
<span class="n">tas_hist_dbcca_monthlyclim</span> <span class="o">=</span> <span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># difference between downscaled and ERA5-Land</span>
<span class="n">bias_clim_dbcca</span> <span class="o">=</span> <span class="n">tas_hist_dbcca_monthlyclim</span> <span class="o">-</span> <span class="n">tas_obs_monthlyclim</span>

<span class="c1"># plot model monthly clim</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;DBCCA CanESM5 1980-2010 tas Monthly Climatology&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tas_hist_dbcca_monthlyclim</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                    <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                                                                    <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Daily Mean Temp. ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6281c7b31b72178bb250998e76b294f6cd554817c7018cd6f4cf58c3ba7d1483.png" src="../_images/6281c7b31b72178bb250998e76b294f6cd554817c7018cd6f4cf58c3ba7d1483.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdd_delta_raw_canesm</span> <span class="o">=</span> <span class="n">cdd_ssp3_raw_ltm</span> <span class="o">-</span> <span class="n">cdd_hist_raw_ltm</span>

<span class="c1"># add units to downscaled data</span>
<span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs using the historical DBCCA data</span>
<span class="n">cdds_hist_dbcca</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_hist_dbcca</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term mean</span>
<span class="n">cdds_hist_dbcca_ltm</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># bias of the downscaled data</span>
<span class="n">cdds_hist_dbcca_ltm_bias</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca_ltm</span> <span class="o">-</span> <span class="n">cdds_obs_ltm</span>

<span class="c1"># add units to downscaled future data</span>
<span class="n">tas_ssp3_dbcca</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs using the SSP3-7.0 DBCCA data</span>
<span class="n">cdds_ssp3_dbcca</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_ssp3_dbcca</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term mean</span>
<span class="n">cdds_ssp3_dbcca_ltm</span> <span class="o">=</span> <span class="n">cdds_ssp3_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># climate change delta</span>
<span class="n">cdds_delta_dbcca_canesm</span> <span class="o">=</span> <span class="n">cdds_ssp3_dbcca_ltm</span> <span class="o">-</span> <span class="n">cdds_hist_dbcca_ltm</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Max Planck Institute Earth System Model (MPI)</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># downloading model data from google cloud</span>

<span class="c1"># open the Google Cloud model data catalog with pandas</span>
<span class="n">df_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url_gcsfs_catalog</span><span class="p">)</span>

<span class="c1"># search for our selected model, both historical and SSP3-7.0 scenarios</span>
<span class="n">search_string</span> <span class="o">=</span> <span class="s2">&quot;table_id == &#39;day&#39; &amp; source_id == &#39;MPI-ESM1-2-LR&#39; &amp; variable_id == &#39;tas&#39;&quot;</span> <span class="c1"># continue on the next line</span>
<span class="n">search_string</span> <span class="o">+=</span> <span class="s2">&quot; &amp; experiment_id == [&#39;historical&#39;, &#39;ssp370&#39;]&quot;</span>
<span class="n">df_search</span> <span class="o">=</span> <span class="n">df_catalog</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">search_string</span><span class="p">)</span>

<span class="c1"># filter the search results further for the ensemble member we want to use</span>
<span class="n">df_search_r10i1p1f1</span> <span class="o">=</span> <span class="n">df_search</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;member_id == &#39;r10i1p1f1&#39;&quot;</span><span class="p">)</span>

<span class="c1"># authenticate access to Google Cloud</span>
<span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="s1">&#39;anon&#39;</span><span class="p">)</span>

<span class="c1"># get the URLs for each dataset and turn into zarr store mappers</span>
<span class="n">url_hist</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;historical&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_hist</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_hist</span><span class="p">)</span>
<span class="n">url_ssp3</span> <span class="o">=</span> <span class="n">df_search_r10i1p1f1</span><span class="p">[</span><span class="n">df_search_r10i1p1f1</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s1">&#39;ssp370&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">zstore</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mapper_ssp3</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">url_ssp3</span><span class="p">)</span>

<span class="c1"># download the datasets, subset, and convert units</span>
<span class="c1"># historical</span>
<span class="n">ds_hist_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_hist</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_hist_raw_earth3</span> <span class="o">=</span> <span class="n">ds_hist_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># also convert to C</span>

<span class="c1"># future</span>
<span class="n">ds_ssp3_raw</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">mapper_ssp3</span><span class="p">,</span> <span class="n">consolidated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tas_ssp3_raw_earth3</span> <span class="o">=</span> <span class="n">ds_ssp3_raw</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lat_bnds</span><span class="p">),</span> <span class="n">lon</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">lon_bnds360</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span> 

<span class="c1"># select time periods</span>
<span class="n">tas_hist_raw_earth3</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_hist</span><span class="p">))</span>
<span class="n">tas_ssp3_raw_earth3</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_future</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># de-chunk along the time dimension, required by xclim bias correction routines</span>
<span class="n">tas_hist_raw_earth3</span>  <span class="o">=</span> <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_ssp3_raw_earth3</span>  <span class="o">=</span> <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
<span class="n">tas_obs</span> <span class="o">=</span> <span class="n">tas_obs</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="c1"># file names for intermediate BCCA files - saving these will help the code run faster later on if all</span>
<span class="c1"># you want to do is the last QDM step</span>

<span class="n">file_hist_earth3_bcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.MPI.toronto.historical.r10i1p1f1.1980-2010.BCCA.nc&quot;</span>
<span class="n">file_ssp3_earth3_bcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.MPI.toronto.ssp370.r10i1p1f1.2070-2100.BCCA.nc&quot;</span>

<span class="c1"># file paths for DBCCA output - it&#39;s good to save this because the code can take a long time to run</span>
<span class="n">file_hist_earth3_dbcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.MPI.toronto.historical.r10i1p1f1.1980-2010.DBCCA.nc&quot;</span>
<span class="n">file_ssp3_earth3_dbcca</span> <span class="o">=</span> <span class="s2">&quot;/home/cchanen/UTCDW/dbcca_data/tas.daily.MPI.toronto.ssp370.r10i1p1f1.2070-2100.DBCCA.nc&quot;</span>

<span class="c1"># open pre-computed DBCCA data if it exists</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_hist_earth3_dbcca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_ssp3_earth3_dbcca</span><span class="p">):</span>
    <span class="n">ds_hist_dbcca</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_hist_dbcca</span><span class="p">)</span>
    <span class="n">tas_hist_dbcca</span> <span class="o">=</span> <span class="n">ds_hist_dbcca</span><span class="o">.</span><span class="n">tas</span>
    <span class="n">ds_ssp3_dbcca</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_ssp3_dbcca</span><span class="p">)</span>
    <span class="n">tas_ssp3_dbcca</span> <span class="o">=</span> <span class="n">ds_ssp3_dbcca</span><span class="o">.</span><span class="n">tas</span> 
<span class="k">else</span><span class="p">:</span> <span class="c1"># do the downscaling - this will only run if the input files don&#39;t already exist</span>
    <span class="n">tas_hist_dbcca</span><span class="p">,</span> <span class="n">tas_ssp3_dbcca</span> <span class="o">=</span> <span class="n">DBCCA</span><span class="p">(</span><span class="n">tas_hist_raw_earth3</span> <span class="p">,</span>
                                           <span class="n">tas_ssp3_raw_earth3</span> <span class="p">,</span>
                                           <span class="n">tas_obs</span><span class="p">,</span>
                                           <span class="s2">&quot;tas&quot;</span><span class="p">,</span> 
                                           <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degC&quot;</span><span class="p">,</span>
                                           <span class="n">fout_hist_bcca</span> <span class="o">=</span> <span class="n">file_hist_earth3_bcca</span><span class="p">,</span>
                                           <span class="n">fout_future_bcca</span> <span class="o">=</span> <span class="n">file_ssp3_earth3_bcca</span><span class="p">,</span>
                                           <span class="n">fout_hist_dbcca</span> <span class="o">=</span> <span class="n">file_hist_earth3_dbcca</span><span class="p">,</span>
                                           <span class="n">fout_future_dbcca</span> <span class="o">=</span> <span class="n">file_ssp3_earth3_dbcca</span><span class="p">,</span>
                                           <span class="n">write_output</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
<span class="c1"># calculate the downscaled model historical monthly climatology</span>
<span class="n">tas_hist_dbcca_monthlyclim</span> <span class="o">=</span> <span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># difference between downscaled and ERA5-Land</span>
<span class="n">bias_clim_dbcca</span> <span class="o">=</span> <span class="n">tas_hist_dbcca_monthlyclim</span> <span class="o">-</span> <span class="n">tas_obs_monthlyclim</span>

<span class="c1"># plot model monthly clim</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes_array</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;DBCCA MPI 1980-2010 tas Monthly Climatology&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tas_hist_dbcca_monthlyclim</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                    <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                                                                    <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Daily Mean Temp. ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7b1f31012a730c9c2ef0c3663b07e4a49c623c1e303bc8d08c8b3cf7f3906616.png" src="../_images/7b1f31012a730c9c2ef0c3663b07e4a49c623c1e303bc8d08c8b3cf7f3906616.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdd_delta_raw_mp</span> <span class="o">=</span> <span class="n">cdd_ssp3_raw_ltm</span> <span class="o">-</span> <span class="n">cdd_hist_raw_ltm</span>

<span class="c1"># add units to downscaled data</span>
<span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs using the historical DBCCA data</span>
<span class="n">cdds_hist_dbcca</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_hist_dbcca</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term mean</span>
<span class="n">cdds_hist_dbcca_ltm</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># bias of the downscaled data</span>
<span class="n">cdds_hist_dbcca_ltm_bias</span> <span class="o">=</span> <span class="n">cdds_hist_dbcca_ltm</span> <span class="o">-</span> <span class="n">cdds_obs_ltm</span>

<span class="c1"># add units to downscaled future data</span>
<span class="n">tas_ssp3_dbcca</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;degC&#39;</span>

<span class="c1"># calculate CDDs using the SSP3-7.0 DBCCA data</span>
<span class="n">cdds_ssp3_dbcca</span> <span class="o">=</span> <span class="n">xci</span><span class="o">.</span><span class="n">cooling_degree_days</span><span class="p">(</span><span class="n">tas_ssp3_dbcca</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># long-term mean</span>
<span class="n">cdds_ssp3_dbcca_ltm</span> <span class="o">=</span> <span class="n">cdds_ssp3_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># climate change delta</span>
<span class="n">cdds_delta_dbcca_mp</span> <span class="o">=</span> <span class="n">cdds_ssp3_dbcca_ltm</span> <span class="o">-</span> <span class="n">cdds_hist_dbcca_ltm</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="comparing-change-in-cdds-for-all-3-models">
<h3>6.6.4.1 Comparing change in CDDs for all 3 models<a class="headerlink" href="#comparing-change-in-cdds-for-all-3-models" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot maps of changes long-term mean CDDs for raw and downscaled CESM2</span>
<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Change in Mean Annual CDDs </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010&quot;</span><span class="p">)</span>

<span class="c1"># CDDS Delta - CanESM5</span>
<span class="n">cdds_delta_dbcca</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CESM2 Downscaled&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">cdd_delta_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CESM2 Raw&quot;</span><span class="p">)</span>

<span class="c1"># CDDS Delta - MP</span>
<span class="n">cdds_delta_dbcca_mp</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MPI Downscaled&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">cdd_delta_raw_mp</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MPI Raw&quot;</span><span class="p">)</span>

<span class="c1"># CDDS Delta - CESM2</span>
<span class="n">cdds_delta_dbcca_canesm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CanESM5 Downscaled&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">cdd_delta_raw_canesm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CanESM5 Raw&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CDD Change&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7eeaf4c70854b3eb8f0118894a998cac1219ae69ce7ba998e7868fae5a096fad.png" src="../_images/7eeaf4c70854b3eb8f0118894a998cac1219ae69ce7ba998e7868fae5a096fad.png" />
</div>
</div>
<p>The plot above demonstrates how changing models can impact the results of downscaling. There is strong agreement between the MPI and CESM2 models, with almost identical high and low areas and scales of CDD change. In the CanESM5 model, changes in cooling degree days are more pronounced, however, the spatial distribution of highs and lows remains consistent, with high CDD change areas along the coast of Lake Ontario and lows in more rural Northern Ontario.</p>
</div>
<div class="section" id="multi-model-mean">
<h3>6.6.4.2 Multi-Model Mean<a class="headerlink" href="#multi-model-mean" title="Permalink to this heading">#</a></h3>
<p>Multi-model means can be a useful way to summarize the results of many different models. Using the mean can help to reduce the impact of irregularities in different models and produce more reliable results. Means should be used carefully, as sometimes the differences between model results such as extreme values could be important to understanding the phenomenon you are looking at, or at understanding the behaviour of particular models.
In this case, with all three models equally weighted the the CanESM5 irregularities are less clear.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot maps of changes long-term mean CDDs for raw and downscaled multi-model</span>
<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Change in Mean Annual CDDs </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010, Multi-Model Mean&quot;</span><span class="p">)</span>

<span class="c1"># CDDS Delta - multi-model</span>
<span class="n">average</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdds_delta_dbcca</span> <span class="o">+</span> <span class="n">cdds_delta_dbcca_mp</span> <span class="o">+</span> <span class="n">cdds_delta_dbcca_canesm</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>

<span class="n">average</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Multi-Model Mean Downscaled&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">cdd_delta_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Multi-Model Mean Raw&quot;</span><span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CDD Change&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/efc80448890c3479e08fb3aaf696025368b6dc239bae9fc888706993b30a3ad2.png" src="../_images/efc80448890c3479e08fb3aaf696025368b6dc239bae9fc888706993b30a3ad2.png" />
</div>
</div>
</div>
</div>
<div class="section" id="exploring-indicator-choices">
<h2>6.6.5 Exploring Indicator Choices<a class="headerlink" href="#exploring-indicator-choices" title="Permalink to this heading">#</a></h2>
<p>The results of both the QDM and DBCCA downscaling demonstrate that cooling degree days are a highly sensitive engineering variable. Small changes in average temperature over a season add up to significant increases in CDDs.</p>
<p>Validating your choice in indicators is an important aspect of the engineering design process. Cooling Degree Days are a standard indicator that is easy to calculate, but may not be the best model for energy demand. Considering other indicators can help validate our choice in indicator and provide a more holistic understanding of future heat.</p>
<p>This section explores the impact of changing the engineering indicator on our results. Shifting from a climatic indicator (from the original model) to an engineering indicator is the last step of our analysis, so no further downscaling is required unless a new variable is required that was not previously downscaled.</p>
<p>The indicator chosen is a custom indicator which approximates of energy demand based on the historical relationship between temperature and energy use in Ontario.</p>
</div>
<div class="section" id="custom-indicator-historical-correlation">
<h2>6.6.5.1 Custom Indicator: Historical Correlation<a class="headerlink" href="#custom-indicator-historical-correlation" title="Permalink to this heading">#</a></h2>
<p>This section uses a custom model developped by Elise Emma Lagace that correlates daily maximum temperature to Ontario Electricity demand. The following figures from her Chapter 3 of her thesis <i> Assessing the Impact of Climate Change on Electricity Planning in Ontario, Canada </i> illustrates the strong correlation between energy use and electricity demand.</p>
<p>The full thesis document can be found here: <a href="https://tspace.library.utoronto.ca/handle/1807/109060">Lagace, 2021</a></p>
<img src="Toronto_Electricity_Images/lagace.png" alt="1"><p>Lagace performed a linear regression relating temperature and energy demand for each IESO region. The results of this regression are summarized in the figure and table below:</p>
<img src="Toronto_Electricity_Images/lagace2.png" alt="2">
<img src="Toronto_Electricity_Images/lagace3.png" alt="2"><p>In order to simplify this stage of the analysis, the “Toronto” IESO zone values will be the focus since this is our primary area of interest, even though the plots in Section 3 cover a wider geographical area encompassing many Southern Ontario zones.</p>
<p>The change in hourly energy demand is presented as a percent change because the formulas provided are based off of total zonal energy demand, and without knowing the spatial distribution of energy use within the zone a downscaled plot with absolute values can not be calculated.</p>
<h4> Defining Energy Use Function: <h4/><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">energy_use</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataout</span><span class="p">):</span> 
    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">dataout</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">46.61</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dataout</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="n">dataout</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">7.21</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="n">dataout</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">106.74</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataout</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">242.87</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">dataout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Appling energy use function to DBCCA data:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_ssp3_dbcca</span> <span class="o">=</span> <span class="n">tas_ssp3_dbcca</span>
<span class="n">energy_hist_dbcca</span> <span class="o">=</span> <span class="n">tas_hist_dbcca</span>

<span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">energy_use</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">tas_ssp3_dbcca</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">energy_ssp3_dbcca</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">energy_use</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">tas_hist_dbcca</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">energy_hist_dbcca</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>


<span class="c1"># long-term mean</span>
<span class="n">energy_ssp3_dbcca_ltm</span> <span class="o">=</span> <span class="n">energy_ssp3_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">energy_hist_dbcca_ltm</span> <span class="o">=</span> <span class="n">energy_hist_dbcca</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># climate change delta</span>
<span class="n">energy_delta_dbcca</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">energy_ssp3_dbcca_ltm</span> <span class="o">-</span> <span class="n">energy_hist_dbcca_ltm</span><span class="p">)</span><span class="o">/</span><span class="n">energy_hist_dbcca_ltm</span>

<span class="c1">#delta in summer</span>
<span class="c1">#group into months</span>
<span class="n">energy_ssp3_dbcca_monthclim</span> <span class="o">=</span> <span class="n">energy_ssp3_dbcca</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">energy_hist_dbcca_monthclim</span> <span class="o">=</span> <span class="n">energy_hist_dbcca</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">monthly_delta</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">energy_ssp3_dbcca_monthclim</span> <span class="o">-</span> <span class="n">energy_hist_dbcca_monthclim</span><span class="p">)</span><span class="o">/</span><span class="n">energy_hist_dbcca_monthclim</span>
<span class="n">august</span> <span class="o">=</span> <span class="n">monthly_delta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Appling energy use function to raw model data:</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_ssp3_raw</span> <span class="o">=</span> <span class="n">tas_ssp3_raw</span>
<span class="n">energy_hist_raw</span> <span class="o">=</span> <span class="n">tas_hist_raw</span>

<span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">energy_use</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">tas_ssp3_raw</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">energy_ssp3_raw</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
    <span class="n">energy_use</span><span class="p">,</span>  <span class="c1"># first the function</span>
    <span class="n">tas_hist_raw</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># now arguments in the order expected by &#39;interp1_np&#39;</span>
    <span class="n">energy_hist_raw</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>


<span class="c1"># long-term mean</span>
<span class="n">energy_ssp3_raw_ltm</span> <span class="o">=</span> <span class="n">energy_ssp3_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">energy_hist_raw_ltm</span> <span class="o">=</span> <span class="n">energy_hist_raw</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># climate change delta</span>
<span class="n">energy_delta_raw</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">energy_ssp3_raw_ltm</span> <span class="o">-</span> <span class="n">energy_hist_raw_ltm</span><span class="p">)</span><span class="o">/</span><span class="n">energy_hist_raw_ltm</span>

<span class="c1">#delta in summer</span>
<span class="c1">#group into months</span>
<span class="n">energy_ssp3_raw_monthclim</span> <span class="o">=</span> <span class="n">energy_ssp3_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">energy_hist_raw_monthclim</span> <span class="o">=</span> <span class="n">energy_hist_raw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">monthly_delta_raw</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">energy_ssp3_raw_monthclim</span> <span class="o">-</span> <span class="n">energy_hist_raw_monthclim</span><span class="p">)</span><span class="o">/</span><span class="n">energy_hist_raw_monthclim</span>
<span class="n">august_raw</span> <span class="o">=</span> <span class="n">monthly_delta_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Plot Change in Hourly Energy Demand: Yearly Average</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot maps of changes long-term mean CDDs for raw and downscaled CanESM5</span>
<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;CESM2 Change in Mean Energy Demand (Yearly Average) </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">1.05</span><span class="p">)</span>

<span class="c1"># downscaled model</span>
<span class="n">energy_delta_dbcca</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;DBCCA&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">energy_delta_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Hourly Energy Demand Change (%)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ba4947b1020ae8c468227530ada9cf38fba3a6865b9b3c4c7196657df19d84ad.png" src="../_images/ba4947b1020ae8c468227530ada9cf38fba3a6865b9b3c4c7196657df19d84ad.png" />
</div>
</div>
<p><strong>Plot change in hourly energy demand: August Average</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Crop to Toronto Area</span>
<span class="n">min_lon1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">79.4</span><span class="o">-</span><span class="mi">1</span>
<span class="n">max_lon1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">79.4</span><span class="o">+</span><span class="mi">1</span>

<span class="n">min_lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">79.4</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">360</span>
<span class="n">min_lat</span> <span class="o">=</span> <span class="mf">43.63</span><span class="o">-</span><span class="mi">1</span>
<span class="n">max_lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">79.4</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">360</span>
<span class="n">max_lat</span> <span class="o">=</span> <span class="mf">43.63</span><span class="o">+</span><span class="mi">1</span>

<span class="n">august_cropped</span> <span class="o">=</span> <span class="n">august</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lat</span><span class="p">,</span><span class="n">max_lat</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lon1</span><span class="p">,</span><span class="n">max_lon1</span><span class="p">))</span>
<span class="n">august_raw_cropped</span> <span class="o">=</span> <span class="n">august_raw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lat</span><span class="p">,</span><span class="n">max_lat</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_lon</span><span class="p">,</span><span class="n">max_lon</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot maps of changes long-term mean CDDs for raw and downscaled CanESM5</span>
<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;CESM2 Change in Mean Energy Demand (August Average) </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">1.05</span><span class="p">)</span>

<span class="c1"># downscaled model</span>
<span class="n">august</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;DBCCA&quot;</span><span class="p">)</span>

<span class="c1"># raw model</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">august_raw</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Hourly Energy Demand Change (%)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5610bb05b75def8f06c022ea5c8ec725d48bc30e2cfba0dcf99f243244280c2a.png" src="../_images/5610bb05b75def8f06c022ea5c8ec725d48bc30e2cfba0dcf99f243244280c2a.png" />
</div>
</div>
<p>The plot above demonstrates that using a custom indicator can provide new insights into the effects of future climate. For example, the distribution of high hourly energy demand change does not exactly match the distribution of increased CDD days from the previous section. There is a much clearer hotspot around Toronto, and the “low” region in Southwestern Ontario observed with CDD days is not present.</p>
<p>The demand change is also notably lower around the Great Lakes when using the custom energy demand indicator. This makes sense because the indicator uses a piecewise function with significantly less sensitivity in the middle of the temperature range (around 15 degrees), and the high specific heat of water means that the temperature would change less rapidly in these areas.</p>
<p>It should be noted that this indicator is still flawed in many ways. The current percent increase in hourly energy demand assumes that the relationship between temperature and energy is the same everywhere in the zone. A better engineering model is needed to produce more meaningful results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#first convert CDD delta values from first section into a percentage</span>
<span class="n">cdd_delta_percent</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">cdds_delta_dbcca</span><span class="o">/</span><span class="n">cdds_ssp3_dbcca_ltm</span><span class="p">)</span>

<span class="c1">#now plot</span>

<span class="n">levels_cdd_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span> <span class="o">=</span> <span class="n">spkws</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>


<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Percent Change in Energy Demand </span><span class="se">\n</span><span class="s2"> SSP3-7.0 2070-2100 minus 1980-2010&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">1.05</span><span class="p">)</span>

<span class="c1"># Using Custom Energy Indicator</span>
<span class="n">august</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Custom Energy Indicator&quot;</span><span class="p">)</span>

<span class="c1"># Using CDDs as Proxy for Energy</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">cdd_delta_percent</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels_cdd_delta</span><span class="p">,</span> 
                              <span class="n">add_colorbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cooling Degree Days&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Hourly Energy Demand Change (%)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon_tor</span><span class="p">,</span> <span class="n">lat_tor</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c5eab9c3cd5f773aef7ca6dc3e6f76f83c5002a91b55644329f35be887f9cea5.png" src="../_images/c5eab9c3cd5f773aef7ca6dc3e6f76f83c5002a91b55644329f35be887f9cea5.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Chapter6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="section6.5_gridded_DBCCA_example.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">6.5 Edmonton AC Loads: Gridded Example</p>
      </div>
    </a>
    <a class="right-next"
       href="../guidebook_references.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">References</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#survey-output">6.6.1 Survey Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#point-based-downscaling-quantile-delta-mapping">6.6.2 Point-Based Downscaling: Quantile-Delta Mapping</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-data">6.6.2.1 Downloading Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-station-data">6.6.2.2 Plotting Station Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-model-data">6.6.2.3 Plotting Model Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-climatologies-and-plotting-temperature-distribution">6.6.2.4 Calculating Climatologies and Plotting Temperature Distribution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-cooling-degree-days">6.6.2.5 Plotting Cooling Degree Days</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downscaling-with-a-spatial-dimension-dbcca">6.6.3 Downscaling with a Spatial Dimension: DBCCA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-different-model-results">6.6.4 Comparing Different Model Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-change-in-cdds-for-all-3-models">6.6.4.1 Comparing change in CDDs for all 3 models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-model-mean">6.6.4.2 Multi-Model Mean</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-indicator-choices">6.6.5 Exploring Indicator Choices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-indicator-historical-correlation">6.6.5.1 Custom Indicator: Historical Correlation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mike Morris, Karen Smith, and Paul Kushner
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>