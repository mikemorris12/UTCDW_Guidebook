

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3.4 Climate Model Output &#8212; UTCDW Guidebook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Chapter3/section3.4_climate_model_output';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.5 Chapter Summary" href="chapter3_summary.html" />
    <link rel="prev" title="3.3 Reanalysis Data" href="section3.3_reanalysis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
  
    <p class="title logo__title">UTCDW Guidebook</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    UTCDW_Guidebook
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Chapter1/chapter1.html">Chapter 1: Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter2/chapter2.html">Chapter 2: Intro to Climate Science and Modeling</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.1_climate_basics.html">2.1 Climate Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.2_climate_modeling.html">2.2 Climate Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/section2.3_climate_model_uncertainty.html">2.3 Climate Model Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/chapter2_summary.html">2.4 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="chapter3.html">Chapter 3: Exploring Climate Data</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="section3.1_station_data.html">3.1 Station Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="section3.2_gridded_obs.html">3.2 Gridded Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="section3.3_reanalysis.html">3.3 Reanalysis Data</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">3.4 Climate Model Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="chapter3_summary.html">3.5 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter4/chapter4.html">Chapter 4 - Statistical Downscaling</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.1_downscaling_basics.html">4.1 Downscaling Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.2_bias_correction_methods.html">4.2 Bias-Correction Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.3_downscaling_methods.html">4.3 Downscaling Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.4_downscaling_validation.html">4.4 Downscaling Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/section4.5_assessing_downscaled_projections.html">4.5 Assessing Downscaled Climate Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/chapter4_summary.html">4.6 Chapter Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter5/chapter5.html">Chapter 5: Downscaling Workflow</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.1_climate_indicators.html">5.1 Climate Indicators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.2_data_selection.html">5.2 Data Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter5/section5.3_exploratory_data_analysis.html">5.3 Exploratory Data Analysis</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Chapter3/section3.4_climate_model_output.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>3.4 Climate Model Output</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#searching-for-data">3.4.1 Searching For Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-data">3.4.2 Downloading Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#opening-and-exploring-the-data">3.4.3 Opening and Exploring the Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exploration-of-model-bias">3.4.4 Basic Exploration of Model Bias</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#significance-testing-for-trends-and-changes">3.4.5 Significance Testing for Trends and Changes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discrete-changes-deltas">3.4.5.1 Discrete Changes (Deltas)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trends">3.4.5.2 Trends</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="climate-model-output">
<h1>3.4 Climate Model Output<a class="headerlink" href="#climate-model-output" title="Permalink to this headline">#</a></h1>
<p>Up until now, this chapter has focused on acquiring and analyzing climate data from observations, or reanalysis data which assimilates observational data into a weather forecast model. These sources of data are only half of the story. Since this guide is about climate change projections, we must also learn how to download and process output from climate model simulations.</p>
<p>Output from climate models that was submitted to the CMIP projects has been made publicly available for download from the <a class="reference external" href="https://esgf.llnl.gov/">Earth System Grid Federation (ESGF)</a>. The ESGF is a peer-to-peer network with nodes hosted by several research centres around the world. The archive of data hosted on a given node can be searched and naviagted in a browser. The website for the node hosted at Lawrence Livermore National Laboratory in the USA can be found <a class="reference external" href="https://esgf-node.llnl.gov/projects/esgf-llnl/">at this link</a>, and links for all of the nodes can be found <a class="reference external" href="https://esgf.llnl.gov/nodes.html">here</a>. Via the browser interface, one can populate their data cart like an online store and generate a <code class="docutils literal notranslate"><span class="pre">wget</span></code> script that when executed, will download the selected data. However, this process can be somewhat cumbersome if you are interested in large amounts of data, or if you wish to create an automated workflow. For advanced users, the ESGF offers a RESTful API, which is outside the scope of this guide. In this guide we will use the Python package (<a class="reference external" href="https://esgf-pyclient.readthedocs.io/en/latest/index.html">esgf-pyclient</a>) (also called <code class="docutils literal notranslate"><span class="pre">pyesgf</span></code>) as an interface to the API. With <code class="docutils literal notranslate"><span class="pre">pyesgf</span></code>, one can either get an OPeNDAP URL to access the data directly, or get a URL from which the data can be downloaded using the Python <code class="docutils literal notranslate"><span class="pre">requests</span></code> library.</p>
<p><a class="reference external" href="https://esgf.github.io/esgf-user-support/index.html">Complete documentation for the ESGF, and all options for accessing the data, can be found here</a>.</p>
<p>As with the reanalysis and gridded observations, climate model output is typically very large in volume. For this reason, we will show examples in this notebook using monthly means instead of daily means or 6-hourly instananeous output, which is typically required for climate impact analysis.</p>
<div class="section" id="searching-for-data">
<h2>3.4.1 Searching For Data<a class="headerlink" href="#searching-for-data" title="Permalink to this headline">#</a></h2>
<p>To search the ESGF archive we must first establish a connection to an ESGF node using the <code class="docutils literal notranslate"><span class="pre">pyesgf.search.SearchConnection</span></code> class. To do this, we pass the URL for the node to <code class="docutils literal notranslate"><span class="pre">SearchConnection</span></code>. Since each node may only host a subset of the complete CMIP archive, the argument <code class="docutils literal notranslate"><span class="pre">distrib</span> <span class="pre">=</span> <span class="pre">True</span></code> tells the API to search across all nodes, not just the one we connected to.</p>
<p>Note: There are sometimes network/service issues with the ESGF nodes, meaning you may sometimes get unexpected errors when using esgf-pyclient. You can try connecting to a different node, or waiting and trying to run the code later. The URLs for each of the nodes, and their operating status, can be found <a class="reference external" href="https://esgf-node.llnl.gov/status/">on this page</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import the required packages</span>
<span class="kn">from</span> <span class="nn">pyesgf.search</span> <span class="kn">import</span> <span class="n">SearchConnection</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">ec3</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

<span class="c1"># use this to suppress a warning which we can ignore</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ESGF_PYCLIENT_NO_FACETS_STAR_WARNING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># establish a connection to the LLNL node</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">SearchConnection</span><span class="p">(</span><span class="s1">&#39;https://esgf-node.llnl.gov/esg-search&#39;</span><span class="p">,</span> <span class="n">distrib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># if that doesn&#39;t work, try the UK node</span>
<span class="c1">#conn = SearchConnection(&#39;https://esgf.ceda.ac.uk/esg-search&#39;, distrib=True)</span>
</pre></div>
</div>
</div>
</div>
<p>After connecting to a node we need to decide which data we’d like to access. The search function takes a number of different search parameters (also called <em>facets</em>), listed and described in the table below. Unfortunately, the names for some of the search parameters are different for the CMIP5 and CMIP6 archives, so both are included in the table.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-center head"><p>Search Criterion</p></th>
<th class="text-center head"><p>CMIP5 Name</p></th>
<th class="text-center head"><p>CMIP6 Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>Project (i.e. CMIP6, CORDEX, etc.)</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">project</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">project</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Model Name</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">model</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">source_id</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Time Frequency</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">time_frequency</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">table_id</span></code> or <code class="docutils literal notranslate"><span class="pre">frequency</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Forcing Scenario</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">experiment</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">experiment_id</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Variable</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">variable</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">Variable</span> <span class="pre">ID</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Ensemble Member</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">ensemble</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">member_id</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Climate domain (i.e. atmosphere, ocean,  land, etc.)</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">realm</span></code></p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">realm</span></code></p></td>
</tr>
</tbody>
</table>
<p>To include multiple values for a search parameter (e.g. if you want data for both historical and SSP5-8.5 forcing scenarios), you can separate the search keywords with a comma (e.g. <code class="docutils literal notranslate"><span class="pre">experiment_id</span> <span class="pre">=</span> <span class="pre">'historical,ssp585'</span></code>. Let’s do exactly this, searching for <code class="docutils literal notranslate"><span class="pre">tas</span></code> (surface air temperature) data at monthly frequency from the model <code class="docutils literal notranslate"><span class="pre">CanESM5</span></code>, the Canadian model contributing to CMIP6. To limit the amount of data involved, we’ll also select only a single ensemble member, instead of the whole ensemble. Dropping the search parameter <code class="docutils literal notranslate"><span class="pre">member_id</span></code> would make the search return results for all ensemble members (if there are multiple members for the model(s)/experiment(s) of interest).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">new_context</span><span class="p">(</span><span class="n">latest</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># search for most recent versions of the file</span>
                         <span class="n">project</span><span class="o">=</span><span class="s2">&quot;CMIP6&quot;</span><span class="p">,</span>
                         <span class="n">experiment_id</span><span class="o">=</span><span class="s1">&#39;historical,ssp585&#39;</span><span class="p">,</span>
                         <span class="n">source_id</span> <span class="o">=</span> <span class="s2">&quot;CanESM5&quot;</span><span class="p">,</span>
                         <span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;mon&#39;</span><span class="p">,</span> <span class="c1"># monthly (&#39;day&#39; for daily, &#39;6hr&#39; for 6-hourly, etc.)</span>
                         <span class="n">member_id</span><span class="o">=</span><span class="s2">&quot;r1i1p1f1&quot;</span><span class="p">,</span>
                         <span class="n">variable_id</span> <span class="o">=</span> <span class="s2">&quot;tas&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">search</span><span class="p">()</span>

<span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12
</pre></div>
</div>
</div>
</div>
<p>Our search returned 12 results, meaning 12 different data files match our search criteria. The results still need a bit more processing until we can get the download URLs (or OPeNDAP URLs) for the data. Next we’ll do this processing, and make a <code class="docutils literal notranslate"><span class="pre">pd.DataFrame</span></code> mapping the file names to the URLs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sometimes running this cell raises an error, but running it a second time seems to work.</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
    <span class="n">hit</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">file_context</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> 
                                 <span class="s1">&#39;download_url&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">download_url</span><span class="p">,</span> 
                                 <span class="s1">&#39;opendap_url&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">opendap_url</span><span class="p">},</span> <span class="n">hit</span><span class="p">))</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<p>We now have a list of 24 files that match our search criteria. This might be a result of the distributed search returning the same data files, hosted on different nodes. Let’s print out all of the file names to check for duplicates, before we do any downloading</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">():</span> <span class="c1"># print in alphabetical order</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001-201412.nc
tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001-201412.nc
tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001-201412.nc
tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001-201412.nc
tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001-201412.nc
tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001-201412.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230012.nc
tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230012.nc
</pre></div>
</div>
</div>
</div>
<p>As suspected, there are duplicates of each file - we really only want 4 files here. One for the historical experiment, and three for different time periods of the SSP5-8.5 experiment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filter the DataFrame to drop duplicate filenames</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span>
<span class="n">files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>filename</th>
      <th>download_url</th>
      <th>opendap_url</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_201501-210...</td>
      <td>http://crd-esgf-drc.ec.gc.ca/thredds/fileServe...</td>
      <td>http://crd-esgf-drc.ec.gc.ca/thredds/dodsC/esg...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_210101-218...</td>
      <td>http://crd-esgf-drc.ec.gc.ca/thredds/fileServe...</td>
      <td>http://crd-esgf-drc.ec.gc.ca/thredds/dodsC/esg...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>tas_Amon_CanESM5_ssp585_r1i1p1f1_gn_218101-230...</td>
      <td>http://crd-esgf-drc.ec.gc.ca/thredds/fileServe...</td>
      <td>http://crd-esgf-drc.ec.gc.ca/thredds/dodsC/esg...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>tas_Amon_CanESM5_historical_r1i1p1f1_gn_185001...</td>
      <td>http://aims3.llnl.gov/thredds/fileServer/css03...</td>
      <td>http://aims3.llnl.gov/thredds/dodsC/css03_data...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="downloading-data">
<h2>3.4.2 Downloading Data<a class="headerlink" href="#downloading-data" title="Permalink to this headline">#</a></h2>
<p>We are now ready to access the data, either directly with <code class="docutils literal notranslate"><span class="pre">xarray</span></code> and the OPenDAP URL, or by downloading and saving the file locally. Since we already know how to do the former, we will do the latter. If you don’t want to save the data in the current working directory, append filename to the path to the directory you’d like to write the data to using <code class="docutils literal notranslate"><span class="pre">os.path.join()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adapted from: https://stackoverflow.com/a/37573701</span>
<span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a file hosted at &lt;url&gt; and write to &lt;filename&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">total_size</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="mi">1024</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">block_size</span><span class="p">),</span>
                         <span class="n">total</span><span class="o">=</span><span class="n">total_size</span><span class="o">//</span><span class="n">block_size</span><span class="p">,</span>
                         <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">total_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">!=</span> <span class="n">total_size</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded size does not match expected size!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
              <span class="s2">&quot;FYI, the status code was &quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a directory (inside the current working directory) to save the data to</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="s2">&quot;CanESM5_tas_monthly&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_directory</span><span class="p">):</span> <span class="c1"># only make the directory if it doesn&#39;t already exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_directory</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the data, one file at a time</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;download_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">path_to_write</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_write</span><span class="p">):</span> <span class="c1"># only download if the files doesn&#39;t already exist</span>
        <span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path_to_write</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="opening-and-exploring-the-data">
<h2>3.4.3 Opening and Exploring the Data<a class="headerlink" href="#opening-and-exploring-the-data" title="Permalink to this headline">#</a></h2>
<p>Now that the files are downloaded and saved, we can open them directly with <code class="docutils literal notranslate"><span class="pre">xarray</span></code> and do some analysis. Let’s plot a time series of temperature near Toronto for the whole record, and compare the historical data to the Toronto City station observations (from Section 3.1).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first open the CanESM5 data, all files at once - open_mfdataset will automatically concatenate them in time</span>
<span class="n">ds_CanESM5</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s2">&quot;/*.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now get obs data - this function is copied and modified from Section 3.1</span>

<span class="n">stn_ids_toronto_city</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5051</span><span class="p">,</span> <span class="mi">31688</span><span class="p">,</span> <span class="mi">41863</span><span class="p">]</span>
<span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stn_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stn_ids_toronto_city</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ec3</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">stn_id</span><span class="p">,</span> 
                      <span class="nb">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># monthly mean data</span>
                      <span class="n">progress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># ensure no duplicate times</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date/Time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df_list</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Date/Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
    <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">df_obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>


<span class="n">column_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date/Time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;Mean Temp (°C)&#39;</span><span class="p">:</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Latitude (y)&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Longitude (x)&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Station Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">}</span>
    
<span class="n">df_obs</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">column_name_dict</span><span class="p">)</span>
<span class="n">df_obs</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">column_name_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
<span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
<span class="n">df_obs</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    
<span class="c1"># sort the data in proper chronological order</span>
<span class="n">df_obs</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># select data only up to 2015, when the &quot;historical&quot; simulation ends</span>
<span class="n">df_obs</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="n">df_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1850</span><span class="p">,</span> <span class="mi">2015</span><span class="p">))]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1850-01-01 00:00:00 2006-12-01 00:00:00
</pre></div>
</div>
</div>
</div>
<p>The monthly data for this station ends at the end of 2006, but we’ll proceed anyways. Since we know there is daily data up until the present, best practice would be to calculate monthly means from the daily means (weighted by the number of days in the month), but we digress.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># interpolate the CanESM5 model data to the station location</span>
<span class="n">station_lat</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">station_lon</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span> <span class="c1"># model data longitudes go from (0, 360) instead of (-180, 180)</span>

<span class="n">tas_CanESM5</span> <span class="o">=</span> <span class="n">ds_CanESM5</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span> <span class="o">=</span> <span class="n">station_lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">station_lon</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># station and model data have different time datatypes, so make a time axis with</span>
<span class="c1"># xarray to use for the obs</span>
<span class="n">times_obs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">cftime_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
                            <span class="c1"># need to add an extra month to the endpoint to make it closed at the right</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span> 
                            <span class="n">freq</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;noleap&#39;</span><span class="p">)</span>
<span class="c1"># plot the time series</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">tas_CanESM5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CanESM5&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_obs</span><span class="p">,</span> <span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Station Obs&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Monthly Mean Temperature in Toronto&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/142999cf00702e0bff2017b32ab131429504e3f11c582c34c9ddd18d6753f348.png" src="../_images/142999cf00702e0bff2017b32ab131429504e3f11c582c34c9ddd18d6753f348.png" />
</div>
</div>
<p>While we should not expect the individual months of the simulated data to match up with the station observations, the degree of overlap is encouraging that the model agrees decently well with observations.</p>
</div>
<div class="section" id="basic-exploration-of-model-bias">
<h2>3.4.4 Basic Exploration of Model Bias<a class="headerlink" href="#basic-exploration-of-model-bias" title="Permalink to this headline">#</a></h2>
<p>To better quantify this, we can plot the probability distribution of each dataset during their common period, and calculate metrics such as the mean bias. Because the model has lower minima than the observations, we might expect it to be biased cold (i.e. negative mean bias). It also has slightly more maxima that exceed the observations, so perhaps it also has a higher standard deviation. Let’s calculate these metrics and add them to the distribution plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select model data during obs period</span>
<span class="n">obs_year_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">times_obs</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">times_obs</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># add one so the range includes the max year</span>
<span class="n">tas_CanESM5_obsperiod</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">obs_year_range</span><span class="p">))</span>

<span class="c1"># fit Kernel Density Estimator so we can plot a smooth distribution</span>
<span class="n">kde_CanESM5</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">tas_CanESM5_obsperiod</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">kde_obs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># need to drop missing values or else scipy complains</span>


<span class="c1"># mean values for each dataset</span>
<span class="n">tas_CanESM5_mean</span> <span class="o">=</span> <span class="n">tas_CanESM5_obsperiod</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">tas_obs_mean</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># stdevs for each dataset</span>
<span class="n">tas_CanESM5_stdev</span> <span class="o">=</span> <span class="n">tas_CanESM5_obsperiod</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">tas_obs_stdev</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># range of temperatures to plot</span>
<span class="n">temperatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Monthly Mean Temperatures in Toronto&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_CanESM5</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CanESM5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperatures</span><span class="p">,</span> <span class="n">kde_obs</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Station Obs&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">([</span><span class="n">tas_CanESM5_mean</span><span class="p">,</span> <span class="n">tas_obs_mean</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="c1"># annotate with mean bias and ratio of stdevs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mf">0.038</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Mean Bias: </span><span class="si">%.2f</span><span class="s1"> $^{\circ}$C&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tas_CanESM5_mean</span> <span class="o">-</span> <span class="n">tas_obs_mean</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">42</span><span class="p">,</span> <span class="mf">0.036</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Stdev Ratio: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tas_CanESM5_stdev</span> <span class="o">/</span> <span class="n">tas_obs_stdev</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/51412ef2bb0abca694a511fd0626ff27afd3a2c0d45b77add573efb915b1dfb2.png" src="../_images/51412ef2bb0abca694a511fd0626ff27afd3a2c0d45b77add573efb915b1dfb2.png" />
</div>
</div>
<p>Indeed the model data for this location is biased slightly low, and has too high of a standard deviation, compared to the station observations. For sub-monthly data, these biases could possibly be worse, which is one reason why downscaling and bias-correction is a necessary part of climate impact analysis.</p>
<p>An interesting feature of these distributions of temperature is that they are <em>bimodal</em>, meaning there are two maxima. This is likely because of the seasonal cycle - the peak near lower temperatures is for cold-season months, and the other is for the warm season. For this reason, we often separate the data by month or by season when quantifying biases (at least for variables that have a strong seasonal cycle). Let’s do this by comparing the monthly climatologies of the two datatsets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate monthly climatologies</span>
<span class="n">tas_monthlyclim_CanESM5</span> <span class="o">=</span> <span class="n">tas_CanESM5_obsperiod</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">tas_monthlyclim_obs</span> <span class="o">=</span> <span class="n">df_obs</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># difference in climatologies</span>
<span class="n">monthlyclim_bias</span> <span class="o">=</span> <span class="n">tas_monthlyclim_CanESM5</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">tas_monthlyclim_obs</span><span class="o">.</span><span class="n">values</span>

<span class="n">months</span> <span class="o">=</span> <span class="n">tas_monthlyclim_CanESM5</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">values</span> 

<span class="c1"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Climatology of Monthly Mean Temperatures in Toronto&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">tas_monthlyclim_CanESM5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CanESM5&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">tas_monthlyclim_obs</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Station Obs&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">monthlyclim_bias</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Model Bias&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Month of the Year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Temperature ($^{\circ}$C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0e5b7941a580a82fff15475f77ff62a3c2280610b3b194cad8871592868fc9c6.png" src="../_images/0e5b7941a580a82fff15475f77ff62a3c2280610b3b194cad8871592868fc9c6.png" />
</div>
</div>
<p>This plot is much more informative! The overall negative mean bias is due to overly cold winter months, but the summer months are also slightly too hot. This is why the model data higher standard deviation than the observations. For a variable with a strong seasonal cycle like temperature, bias correction should be done with data grouped by the day or month of the year, to account for seasonally-varying biases.</p>
</div>
<div class="section" id="significance-testing-for-trends-and-changes">
<h2>3.4.5 Significance Testing for Trends and Changes<a class="headerlink" href="#significance-testing-for-trends-and-changes" title="Permalink to this headline">#</a></h2>
<p>When analyzing future climate projections, an important question to ask early in your study is whether your climate variables of interest show significant trends or changes over the time horizon you plan to study. If, for example, you are interested in using precipitation data to drive a hydrology model and investigate how flooding might change for a certain catchment under climate change, but the changes to precipitation in your study area are not statistically significant, then your impact study will likely also have a null result.</p>
<div class="section" id="discrete-changes-deltas">
<h3>3.4.5.1 Discrete Changes (Deltas)<a class="headerlink" href="#discrete-changes-deltas" title="Permalink to this headline">#</a></h3>
<p>There are a number of methods that climate scientists use to assess if climate change signals are significant. These methods range in complexity and statistical robustness. The simplest method would be to calculate the climatological standard deviation for the historical period, and check if the projected mean change falls outside the one-sigma range. This method does not account for possible changes to the variance in the future period, the form of the distributions of the data (i.e. non-Gaussian variables like precipitation or wind speed), and is not very statistically robust. This extraordinarily simple method should only be used as a first rough assessment, and should not give much confidence that the changes are truly statistically significant.</p>
<p>The next best way to test if a mean change is statistically significant is the two sample Student’s <a class="reference external" href="https://en.wikipedia.org/wiki/Student%27s_t-test"><span class="math notranslate nohighlight">\(t\)</span>-test</a>. This is a very common statistical test, used to assess if two different sets of data have different mean values. For large datasets, the <a class="reference external" href="https://en.wikipedia.org/wiki/Central_limit_theorem">central limit theorem</a> tells us that the distribution of the sample mean tends towards a Gaussian distribution even for non-Gaussian variables, so we don’t usually need to be concerned about the assumption of Gaussian distributions inherent to the <span class="math notranslate nohighlight">\(t\)</span>-test. However, we <em>do</em> need to be concerned about the assumption that each sample is <em>independent</em>. With time series data, especially climate time series data, there are nearly always significant serial dependence in the data. In other words, today’s weather is strongly related to yesterday’s weather, which means that data points close in time are not statistically independent of each other. For serially correlated data, the number of independent samples is not equal to the actual total number of samples. We instead calculate an <em>effective sample size</em> using the following formula (<a class="reference external" href="https://librarysearch.library.utoronto.ca/permalink/01UTORONTO_INST/14bjeso/alma991106907255706196">Wilks, 2011</a>):</p>
<div class="math notranslate nohighlight">
\[N_{eff} = N \frac{1 - \rho_{1}}{1 + \rho_{1}} \]</div>
<p>Where <span class="math notranslate nohighlight">\(\rho_{1}\)</span> is the <em>lag-one temporal autocorrelation</em> of the time series. For a time series <span class="math notranslate nohighlight">\(x(t)\)</span> with time step <span class="math notranslate nohighlight">\(\Delta t\)</span>, this is the correlation between <span class="math notranslate nohighlight">\(x(t)\)</span> and <span class="math notranslate nohighlight">\(x(t-\Delta t)\)</span>.</p>
<p>Using the effective sample size correction, let’s use the two sample Student’s <span class="math notranslate nohighlight">\(t\)</span>-test to check if the monthly mean temperatures for Toronto in CanESM5 change significantly from the 1971-2000 period to the 2071-2100 period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select historical and future periods</span>
<span class="n">tas_CanESM5_hist</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1971</span><span class="p">,</span> <span class="mi">2001</span><span class="p">)))</span>
<span class="n">tas_CanESM5_future</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2071</span><span class="p">,</span> <span class="mi">2101</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate effective sample size for historical and future periods</span>
<span class="k">def</span> <span class="nf">effective_sample_size</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">ntime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="c1"># times not including the final timestep</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntime</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># data not including the first timestep</span>
    <span class="n">data_lag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntime</span><span class="p">))</span>
    <span class="c1"># match up time values, otherwise the xr.corr function won&#39;t return the correct output</span>
    <span class="n">data_lag</span> <span class="o">=</span> <span class="n">data_lag</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">times</span><span class="p">)</span>
    
    <span class="c1"># calculate correlation</span>
    <span class="n">autocor</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">times</span><span class="p">),</span>
                      <span class="n">data_lag</span><span class="p">,</span>
                      <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
    
    <span class="n">neff</span> <span class="o">=</span> <span class="n">ntime</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">autocor</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">autocor</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">neff</span>

<span class="n">neff_hist</span> <span class="o">=</span> <span class="n">effective_sample_size</span><span class="p">(</span><span class="n">tas_CanESM5_hist</span><span class="p">)</span>
<span class="n">neff_future</span> <span class="o">=</span> <span class="n">effective_sample_size</span><span class="p">(</span><span class="n">tas_CanESM5_future</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate means and stdevs for each period</span>
<span class="n">tas_CanESM5_hist_mean</span> <span class="o">=</span> <span class="n">tas_CanESM5_hist</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">tas_CanESM5_future_mean</span> <span class="o">=</span> <span class="n">tas_CanESM5_future</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="n">tas_CanESM5_hist_std</span> <span class="o">=</span> <span class="n">tas_CanESM5_hist</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">tas_CanESM5_future_std</span> <span class="o">=</span> <span class="n">tas_CanESM5_future</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># perform two_sample t-test to see if future temperatures are higher than past</span>
<span class="n">tstat</span><span class="p">,</span> <span class="n">pval_neff</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind_from_stats</span><span class="p">(</span><span class="n">tas_CanESM5_hist_mean</span><span class="p">,</span>
                                              <span class="n">tas_CanESM5_hist_std</span><span class="p">,</span>
                                              <span class="n">neff_hist</span><span class="p">,</span>
                                              <span class="n">tas_CanESM5_future_mean</span><span class="p">,</span> 
                                              <span class="n">tas_CanESM5_future_std</span><span class="p">,</span> 
                                              <span class="n">neff_future</span><span class="p">,</span>
                                              <span class="n">equal_var</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                              <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;less&#39;</span><span class="p">)</span> 
<span class="c1"># alt hypothesis is that the first dataset (historical) has a lower mean than the second dataset (future)</span>

<span class="c1"># do it again using the total sample size, to demonstrate how the p-value will be underestimated</span>
<span class="n">tstat</span><span class="p">,</span> <span class="n">pval_ntot</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind_from_stats</span><span class="p">(</span><span class="n">tas_CanESM5_hist_mean</span><span class="p">,</span>
                                              <span class="n">tas_CanESM5_hist_std</span><span class="p">,</span>
                                              <span class="nb">len</span><span class="p">(</span><span class="n">tas_CanESM5_hist</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                                              <span class="n">tas_CanESM5_future_mean</span><span class="p">,</span> 
                                              <span class="n">tas_CanESM5_future_std</span><span class="p">,</span> 
                                              <span class="nb">len</span><span class="p">(</span><span class="n">tas_CanESM5_future</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                                              <span class="n">equal_var</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                              <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;less&#39;</span><span class="p">)</span>

<span class="c1"># print each p-value to 6 significant figures</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Sample Size p-value: </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pval_ntot</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Effective Sample Size p-value: </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pval_neff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total Sample Size p-value: 0.000000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Effective Sample Size p-value: 0.001478
</pre></div>
</div>
</div>
</div>
<p>Comparing the p-values calculating using the total sample size and the effective sample size confirms that failing to account for serial dependence in the data leads to overconfidence in the significance of results. For this case, the mean change is still significant after accounting for serial dependence, but this may not always be the true. If the lag-1 autocorrelation is big enough, or if the magnitude of the change is small enough, then failing to correct for the influence of serial dependence might lead you to mistake a null result for a significant one.</p>
</div>
<div class="section" id="trends">
<h3>3.4.5.2 Trends<a class="headerlink" href="#trends" title="Permalink to this headline">#</a></h3>
<p>Sometimes a climate study might not focus on differences between a future and historical time period, but instead focus on rates of change of a certain variable, i.e. a trend. Your first thought might be to use ordinary least squares to do a linear regression and test for significance of the slope parameter, but this will result in a similar issue to the one we just worked through. Ordinary linear regression assumes that all of the data samples are independent, so the presence of serial correlations will inflate the p-value. Additionally, many climate trends are nonlinear. Even global mean surface air temperature, possibly the most studied and well-understood climate variable, has been shown to have an accelerating trend over the past several decades (<a class="reference external" href="https://www.ipcc.ch/report/ar6/wg1/chapter/chapter-2/">Gulev et al., 2021</a>). For these reasons, more robust statistical tests have been developed for testing the significance of trends of serially correlated climate data.</p>
<p>Here we will use the Mann-Kendall trend test (<a class="reference external" href="https://librarysearch.library.utoronto.ca/permalink/01UTORONTO_INST/14bjeso/alma991106907255706196">Wilks, 2011</a>) to test signficance of the trend in monthly mean temperatures in Toronto, as simulated by CanESM5. Unfortunately, this test is not implemented in <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code>, but it is simple enough to code ourselves.</p>
<p>The Mann-Kendall test is a nonparametric test for the presence of a trend in a time series. The test statistic for this test is (from <a class="reference external" href="https://doi.org/10.1023/B:WARM.0000043140.61082.60">Yue and Wang (2004)</a>):</p>
<div class="math notranslate nohighlight">
\[S = \sum_{i=1}^{N-1} \sum_{j=i+1}^{N} sgn(x_{j} - x_{i}) \]</div>
<p>Where <span class="math notranslate nohighlight">\(sgn(y)\)</span> is <span class="math notranslate nohighlight">\(+1\)</span> if <span class="math notranslate nohighlight">\(y\)</span> is positive, <span class="math notranslate nohighlight">\(-1\)</span> if <span class="math notranslate nohighlight">\(y\)</span> is negative, and 0 if <span class="math notranslate nohighlight">\(y\)</span> is exactly zero. <span class="math notranslate nohighlight">\(S\)</span> is a count of how many pairs of data show increases over time minus the number that show decreases. For long enough time series (more than about 10 samples), <span class="math notranslate nohighlight">\(S\)</span> is approximately Gaussian, and under the null hypothesis of no trend, <span class="math notranslate nohighlight">\(S\)</span> should not be significantly different from zero. Wilks tells us that the variance of <span class="math notranslate nohighlight">\(S\)</span> depends on how many of the <span class="math notranslate nohighlight">\(x_{i}\)</span>’s are unique. If there are no repeated values, then</p>
<div class="math notranslate nohighlight">
\[
Var(S) = \frac{n(n-1)(2n+5)}{18}
\]</div>
<p>And if there are any ties (repeated values), then</p>
<div class="math notranslate nohighlight">
\[
Var(S) = \frac{n(n-1)(2n+5) - \sum_{j=1}^{J}t_{j}(t_{j}-1)(2t_{j}+5)}{18}
\]</div>
<p>Where <span class="math notranslate nohighlight">\(J\)</span> is the number of values that are repeated, and <span class="math notranslate nohighlight">\(t_{j}\)</span> is the number of instances of the <span class="math notranslate nohighlight">\(j\)</span>’th non-unique value. Climate model data are floating point decimal numbers, so it is very rare to have two values that are exactly repeated, so we won’t worry about this case here. If you are working with data that is only recorded to a finite tolerance (like for certain types of observational data), then you’ll likely need to account for repeated values when calculating <span class="math notranslate nohighlight">\(S\)</span> for the Mann-Kendall test.</p>
<p>Conveniently, we can use the function <code class="docutils literal notranslate"><span class="pre">scipy.stats.kendaltau</span></code> to help us calculate <span class="math notranslate nohighlight">\(S\)</span>, since when there are no repeated values, <span class="math notranslate nohighlight">\(S = \frac{N(N-1)}{2}\tau\)</span>, where <span class="math notranslate nohighlight">\(\tau\)</span> is the <a class="reference external" href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">Kendall rank correlation coefficient</a>. This statistic is  related to the Mann-Kendall test, sort of like how the Pearson correlation is related to ordinary linear regression. The issue with <code class="docutils literal notranslate"><span class="pre">scipy.stats.kendaltau</span></code> is that it will return a p-value that does not account for serial correlation, so we can’t use it for hypothesis testing.</p>
<p>To account for the serial correlation, we can use the relationship between the sample size <span class="math notranslate nohighlight">\(N\)</span> and the variance to define an effective variance:</p>
<div class="math notranslate nohighlight">
\[
Var^{*}(S) = Var(S) \frac{1 + \rho_{1}}{1 - \rho_{1}}
\]</div>
<p>Having calculated our test statistic and its variance, and knowing that the sampling distribution of <span class="math notranslate nohighlight">\(S\)</span> is Gaussian, we can convert <span class="math notranslate nohighlight">\(S\)</span> to a standardized value <span class="math notranslate nohighlight">\(z\)</span> that follows standard Gaussain distribution (i.e. a mean of zero and variance of 1). The conversion goes like:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
z = \left\{
        \begin{array}{ll}
            \frac{S-1}{\sqrt{Var^{*}(S)}} &amp; \quad S \gt 0 \\
            \frac{S+1}{\sqrt{Var^{*}(S)}} &amp; \quad S \lt 0
        \end{array}
    \right.
\end{align*}
\end{split}\]</div>
<p>The p-value can then be calculated using the one-minus the CDF of a standard Gaussian (i.e. <code class="docutils literal notranslate"><span class="pre">scipy.stats.norm.sf</span></code>). Let’s code this up and perform the Mann-Kendall test for the trend in our climate model data up to the year 2100.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mann_kendall_pvalue</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="c1"># kendall tau  - the np.arange(N) is there to represent the monotonically increasing time axis</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kendalltau</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># use tau to calculate the S statistic</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># calculate the variance and effective variance,</span>
    <span class="c1"># taking advantage of our effective_sample_size function from the last example</span>
    <span class="n">var_S</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">18</span>
    <span class="n">N_eff</span> <span class="o">=</span> <span class="n">effective_sample_size</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">N_eff</span>
    <span class="n">var_S_eff</span> <span class="o">=</span> <span class="n">var_S</span> <span class="o">*</span> <span class="n">correction_factor</span>
    
    <span class="c1"># standarize S to a z-score</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">S</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_S_eff</span><span class="p">)</span>
    
    <span class="c1"># calculate one-sided p-value using the standard normal distribution</span>
    <span class="n">pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pval</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pval_trend_mk</span> <span class="o">=</span> <span class="n">mann_kendall_pvalue</span><span class="p">(</span><span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">tas_CanESM5</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mann-Kendall Test p-value for Trend: </span><span class="si">%.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pval_trend_mk</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mann-Kendall Test p-value for Trend: 0.000083
</pre></div>
</div>
</div>
</div>
<p>Since the p-value is very small for this robust test, we can confidently reject the null hypothesis of no trend, and conclude that CanESM5 projects a significant increasing trend in Toronto monthly mean temperatures. When we move to looking at downscaled data from this model, we should expect to see results that are qualitatively similar, only with reduced biases relative to observations, and spatial information on a finer grid.</p>
<p>This notebook has worked through the process of downloading CMIP6 climate model data from the ESGF, and doing some basic model validation using station observations. Any other data hosted on the ESGF, including CORDEX regional climate model data, can be accessed in the same way. Users are encouraged to navigate the ESGF web portal before using <code class="docutils literal notranslate"><span class="pre">pyesgf</span></code> to ensure you’re using the correct facet names for the project you’re searching, and that the search is returning the results you expect.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Chapter3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="section3.3_reanalysis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">3.3 Reanalysis Data</p>
      </div>
    </a>
    <a class="right-next"
       href="chapter3_summary.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">3.5 Chapter Summary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#searching-for-data">3.4.1 Searching For Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-data">3.4.2 Downloading Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#opening-and-exploring-the-data">3.4.3 Opening and Exploring the Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-exploration-of-model-bias">3.4.4 Basic Exploration of Model Bias</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#significance-testing-for-trends-and-changes">3.4.5 Significance Testing for Trends and Changes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discrete-changes-deltas">3.4.5.1 Discrete Changes (Deltas)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trends">3.4.5.2 Trends</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mike Morris, Karen Smith, and Paul Kushner
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>